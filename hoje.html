<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hoje</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

<style>
html, body {
  margin:0;
  padding:0;
  background-color:#fff;
  font-family:"DM Sans", sans-serif;
  height:100%;
}

.navbar {
  background-color:#000;
  padding:12px 20px;
  display:flex;
  justify-content:flex-end;
  gap:30px;
  font-family:"Montserrat", sans-serif;
}

.navbar a {
  color:#fff;
  text-decoration:none;
}

.container {
  width:95%;
  max-width:1400px;
  margin:30px auto;
}

.table-title {
  text-align:center;
  margin-bottom:20px;
  font-family:"Montserrat";
  font-size:18px;
  color:#1E4DB7;
}

.table-wrapper {
  overflow-x:auto;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

.hoje-table {
  width:100%;
  border-collapse:collapse;
  font-family:"Montserrat";
  font-size:13px;
}

.hoje-table th {
  background-color:#164CAD;
  color:white;
  padding:12px 8px;
}

.hoje-table td {
  padding:10px 8px;
  border-bottom:1px solid #e0e0e0;
  text-align:center;
}

.hoje-table tbody tr:nth-child(even) {
  background-color:#f9f9f9;
}
</style>
</head>

<body>

<nav class="navbar">
  <a href="index.html">Histórico</a>
  <a href="hoje.html">Hoje</a>
</nav>

<div class="container">

<div class="table-title">
Acompanhamento Diário - Ibovespa
</div>

<div class="table-wrapper">

<table class="hoje-table">
<thead>
<tr>
<th>Ação</th>
<th>Setor</th>
<th>Peso no<br>Ibov</th>
<th>Variação %<br>Hoje</th>
<th>Contribuição<br>para Ibov</th>
<th>% da<br>contribuição</th>
</tr>
</thead>

<tbody id="tabelaHojeBody">
<!-- preenchido via JS -->
</tbody>

</table>

</div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjEpwKbe5Q2Em0ZexDiCjBT1qUjr2SM2xCuROpQKnHr64XxUqaZ4p2eQurmL_4JTt45Wr-Ok5GRTdn/pub?output=csv";

function parseCSV(texto) {
  const linhas = [];
  let linhaAtual = [];
  let campo = '';
  let dentroAspas = false;

  for (let i = 0; i < texto.length; i++) {
    let char = texto[i];
    let proximo = texto[i + 1];

    if (dentroAspas) {
      if (char === '"' && proximo === '"') {
        campo += '"';
        i++;
      } else if (char === '"') {
        dentroAspas = false;
      } else {
        campo += char;
      }
    } else {
      if (char === '"') {
        dentroAspas = true;
      } else if (char === ',') {
        linhaAtual.push(campo);
        campo = '';
      } else if (char === '\n' || char === '\r') {
        if (char === '\r' && proximo === '\n') i++;
        linhaAtual.push(campo);
        linhas.push(linhaAtual);
        linhaAtual = [];
        campo = '';
      } else {
        campo += char;
      }
    }
  }

  if (campo || linhaAtual.length > 0) {
    linhaAtual.push(campo);
    linhas.push(linhaAtual);
  }

  return linhas;
}

function formatarPeso(valor) {
  if (!valor || valor.trim() === '') return '-';
  // Substitui vírgula por ponto para conversão numérica
  const numStr = valor.trim().replace(',', '.');
  const num = parseFloat(numStr);
  if (isNaN(num)) return '-';
  return num.toFixed(2) + '%';
}

async function carregarDados() {
  try {
    const resposta = await fetch(CSV_URL);
    const csvTexto = await resposta.text();
    const csvLimpo = csvTexto.replace(/^\uFEFF/, '');
    const linhas = parseCSV(csvLimpo);

    const tbody = document.getElementById("tabelaHojeBody");
    tbody.innerHTML = "";

    if (linhas.length < 2) {
      tbody.innerHTML = '<tr><td colspan="6">Arquivo CSV com poucas linhas</td></tr>';
      return;
    }

    // Mapa ação -> setor (colunas 138 a 268 das linhas 0 e 1)
    const acaoParaSetor = {};
    const linhaSetor = linhas[0];
    const linhaCodigo = linhas[1];

    for (let col = 138; col <= 268; col++) {
      if (linhaCodigo.length > col && linhaSetor.length > col) {
        const codigo = linhaCodigo[col] ? linhaCodigo[col].trim() : '';
        const setor = linhaSetor[col] ? linhaSetor[col].trim() : '';
        if (codigo !== '' && setor !== '') {
          acaoParaSetor[codigo] = setor;
        }
      }
    }

    let linhasAdicionadas = 0;
    // Começa da linha 2 (índice 2) — as duas primeiras são metadados
    for (let i = 2; i < linhas.length; i++) {
      const linha = linhas[i];
      if (linha.length > 300) {
        const acao = linha[300] ? linha[300].trim() : '';
        if (acao !== '') {
          const setor = acaoParaSetor[acao] || '-';
          const pesoRaw = (linha.length > 301 && linha[301]) ? linha[301] : '';
          const pesoFormatado = formatarPeso(pesoRaw);
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${acao}</td>
            <td>${setor}</td>
            <td>${pesoFormatado}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
          tbody.appendChild(tr);
          linhasAdicionadas++;
        }
      }
    }

    if (linhasAdicionadas === 0) {
      tbody.innerHTML = '<tr><td colspan="6">Nenhuma ação encontrada na coluna 300</td></tr>';
    }

  } catch (erro) {
    console.error("Erro ao carregar dados:", erro);
    const tbody = document.getElementById("tabelaHojeBody");
    tbody.innerHTML = '<tr><td colspan="6" style="color:red;">Erro ao carregar dados. Verifique o console.</td></tr>';
  }
}

carregarDados();
</script>

</body>
</html>
