<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hoje</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* (mesmo estilo do original, sem alterações) */
html, body { margin:0; padding:0; background-color:#fff; font-family:"DM Sans", sans-serif; height:100%; }
.navbar { background-color:#000; padding:12px 20px; display:flex; justify-content:flex-end; gap:30px; font-family:"Montserrat", sans-serif; }
.navbar a { color:#fff; text-decoration:none; }
.container { width:95%; max-width:1400px; margin:30px auto; }
.ibovespa-box { border:1px solid #000; padding:15px 20px; margin-bottom:25px; margin-left:auto; margin-right:auto; max-width:400px; font-family:"Montserrat", sans-serif; background-color:#f9f9f9; border-radius:4px; text-align:center; }
.ibovespa-box div { margin:5px 0; }
.ibovespa-box span { font-weight:700; color:#164CAD; }
.header-container { display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; flex-wrap:wrap; gap:10px; }
.header-container .table-title { font-family:"Montserrat", sans-serif; font-size:18px; color:#1E4DB7; margin:0; flex:1; text-align:center; }
.refresh-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background-color:#164CAD; color:white; font-size:20px; cursor:pointer; transition:background-color 0.2s; border:none; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.refresh-btn:hover { background-color:#0d3a8c; }
.refresh-btn:active { transform:scale(0.95); }
.refresh-img { width:28px; height:auto; cursor:pointer; transition:opacity 0.2s; }
.refresh-img:hover { opacity:0.7; }
.refresh-img:active { transform:scale(0.95); }
.table-wrapper { overflow-x:auto; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); position:relative; }
.hoje-table { width:100%; border-collapse:collapse; font-family:"Montserrat"; font-size:13px; }
.hoje-table th { background-color:#164CAD; color:white; padding:12px 8px; text-align:center; position:relative; cursor:pointer; user-select:none; }
.hoje-table th.sortable:hover { background-color:#1e5bbf; }
.hoje-table th .sort-icon { margin-left:5px; font-size:14px; }
.hoje-table td { padding:10px 8px; border-bottom:1px solid #e0e0e0; text-align:center; }
.hoje-table tbody tr:nth-child(even) { background-color:#f9f9f9; }
</style>
</head>
<body>

<nav class="navbar">
  <a href="index.html">Histórico</a>
  <a href="hoje.html">Hoje</a>
</nav>

<div class="container">
  <div id="ibovespaBox" class="ibovespa-box"><div>Carregando...</div></div>

  <div class="header-container">
    <div class="table-title">Acompanhamento Diário - Ibovespa</div>
    <div id="refreshButton" class="refresh-btn" title="Atualizar dados" role="button" tabindex="0">
      <img src="refresh.png" alt="↻" class="refresh-img" id="refreshImg" onerror="this.style.display='none'; this.parentElement.innerHTML='↻';">
    </div>
  </div>

  <div class="table-wrapper">
    <table class="hoje-table" id="tabelaHoje">
      <thead>
        <tr>
          <th>Ação</th>
          <th>Setor</th>
          <th id="col-peso" class="sortable">Peso no<br>Ibov <span class="sort-icon" id="sort-icon-peso"></span></th>
          <th id="col-variacao" class="sortable">Variação %<br>Hoje <span class="sort-icon" id="sort-icon-variacao"></span></th>
          <th id="col-contribuicao" class="sortable">Contribuição<br>para Ibov <span class="sort-icon" id="sort-icon-contribuicao"></span></th>
          <th>% da<br>contribuição</th>
        </tr>
      </thead>
      <tbody id="tabelaHojeBody"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL_HOJE = "https://us-central1-ibovespa-ae47d.cloudfunctions.net/api/hoje";

let dadosAcoes = [];
let ordenacao = { coluna: null, direcao: 'asc' };

const iconPeso = document.getElementById('sort-icon-peso');
const iconVariacao = document.getElementById('sort-icon-variacao');
const iconContribuicao = document.getElementById('sort-icon-contribuicao');

function atualizarIconesOrdenacao() {
  iconPeso.innerHTML = iconVariacao.innerHTML = iconContribuicao.innerHTML = '';
  if (ordenacao.coluna) {
    const seta = ordenacao.direcao === 'asc' ? '▲' : '▼';
    if (ordenacao.coluna === 'peso') iconPeso.innerHTML = seta;
    else if (ordenacao.coluna === 'variacao') iconVariacao.innerHTML = seta;
    else if (ordenacao.coluna === 'contribuicao') iconContribuicao.innerHTML = seta;
  }
}

function ordenarDados() {
  if (!ordenacao.coluna) return;
  const chave = ordenacao.coluna === 'peso' ? 'pesoNum' :
                ordenacao.coluna === 'variacao' ? 'variacaoNum' : 'contribuicaoNum';
  dadosAcoes.sort((a, b) => {
    let valA = a[chave], valB = b[chave];
    if (isNaN(valA) && isNaN(valB)) return 0;
    if (isNaN(valA)) return 1;
    if (isNaN(valB)) return -1;
    return ordenacao.direcao === 'asc' ? valA - valB : valB - valA;
  });
}

function renderizarTabela() {
  const tbody = document.getElementById("tabelaHojeBody");
  tbody.innerHTML = '';
  if (dadosAcoes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6">Nenhum dado disponível</td></tr>';
    return;
  }
  for (const item of dadosAcoes) {
    tbody.innerHTML += `<tr>
      <td>${item.acao}</td>
      <td>${item.setor}</td>
      <td>${item.pesoFormatado}</td>
      <td>${item.variacaoFormatada}</td>
      <td>${item.contribuicaoFormatada}</td>
      <td>${item.pctContribuicaoFormatada}</td>
    </tr>`;
  }
  atualizarIconesOrdenacao();
}

async function carregarDados() {
  const tbody = document.getElementById("tabelaHojeBody");
  const ibovespaBox = document.getElementById("ibovespaBox");
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Carregando...</td></tr>';
  ibovespaBox.innerHTML = '<div>Carregando...</div>';

  try {
    const response = await fetch(API_URL_HOJE);
    if (!response.ok) throw new Error(`Erro ${response.status}`);
    const data = await response.json();

    ibovespaBox.innerHTML = `
      <div>Ibovespa Hoje: <span>${data.valorIbovespaFormatado || '-'}</span></div>
      <div>Variação: <span>${data.variacaoIbovespaFormatada || '-'}</span></div>
      <div>Atualizado em: <span>${data.dataAtualizacao || 'indisponível'}</span></div>
    `;

    dadosAcoes = data.acoes || [];
    if (ordenacao.coluna) ordenarDados();
    renderizarTabela();
  } catch (erro) {
    console.error(erro);
    tbody.innerHTML = '<tr><td colspan="6" style="color:red;">Erro ao carregar dados</td></tr>';
    ibovespaBox.innerHTML = '<div>Erro ao carregar dados</div>';
  }
}

function configurarOrdenacao() {
  document.getElementById('col-peso').addEventListener('click', () => {
    ordenacao = { coluna: 'peso', direcao: ordenacao.coluna === 'peso' ? (ordenacao.direcao === 'asc' ? 'desc' : 'asc') : 'asc' };
    ordenarDados(); renderizarTabela();
  });
  document.getElementById('col-variacao').addEventListener('click', () => {
    ordenacao = { coluna: 'variacao', direcao: ordenacao.coluna === 'variacao' ? (ordenacao.direcao === 'asc' ? 'desc' : 'asc') : 'asc' };
    ordenarDados(); renderizarTabela();
  });
  document.getElementById('col-contribuicao').addEventListener('click', () => {
    ordenacao = { coluna: 'contribuicao', direcao: ordenacao.coluna === 'contribuicao' ? (ordenacao.direcao === 'asc' ? 'desc' : 'asc') : 'asc' };
    ordenarDados(); renderizarTabela();
  });
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('refreshButton').addEventListener('click', carregarDados);
  configurarOrdenacao();
  carregarDados();
});
</script>

</body>
</html>
