<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hoje</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

<style>
html, body {
  margin:0;
  padding:0;
  background-color:#fff;
  font-family:"DM Sans", sans-serif;
  height:100%;
}

.navbar {
  background-color:#000;
  padding:12px 20px;
  display:flex;
  justify-content:flex-end;
  gap:30px;
  font-family:"Montserrat", sans-serif;
}

.navbar a {
  color:#fff;
  text-decoration:none;
}

.container {
  width:95%;
  max-width:1400px;
  margin:30px auto;
}

.ibovespa-box {
  border: 1px solid #000;
  padding: 15px 20px;
  margin-bottom: 25px;
  margin-left: auto;
  margin-right: auto;
  max-width: 400px;
  font-family: "Montserrat", sans-serif;
  background-color: #f9f9f9;
  border-radius: 4px;
  text-align: center;
}

.ibovespa-box div {
  margin: 5px 0;
}

.ibovespa-box span {
  font-weight: 700;
  color: #164CAD;
}

.table-title {
  text-align:center;
  margin-bottom:20px;
  font-family:"Montserrat";
  font-size:18px;
  color:#1E4DB7;
}

.table-wrapper {
  overflow-x:auto;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

.hoje-table {
  width:100%;
  border-collapse:collapse;
  font-family:"Montserrat";
  font-size:13px;
}

.hoje-table th {
  background-color:#164CAD;
  color:white;
  padding:12px 8px;
}

.hoje-table td {
  padding:10px 8px;
  border-bottom:1px solid #e0e0e0;
  text-align:center;
}

.hoje-table tbody tr:nth-child(even) {
  background-color:#f9f9f9;
}
</style>
</head>

<body>

<nav class="navbar">
  <a href="index.html">Histórico</a>
  <a href="hoje.html">Hoje</a>
</nav>

<div class="container">

<!-- Quadro da Variação do Ibovespa -->
<div id="ibovespaBox" class="ibovespa-box">
  <div>Carregando...</div>
</div>

<div class="table-title">
Acompanhamento Diário - Ibovespa
</div>

<div class="table-wrapper">

<table class="hoje-table">
<thead>
<tr>
<th>Ação</th>
<th>Setor</th>
<th>Peso no<br>Ibov</th>
<th>Variação %<br>Hoje</th>
<th>Contribuição<br>para Ibov</th>
<th>% da<br>contribuição</th>
</tr>
</thead>

<tbody id="tabelaHojeBody">
<!-- preenchido via JS -->
</tbody>

</table>

</div>
</div>

<script>
const CSV_URL_PRINCIPAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjEpwKbe5Q2Em0ZexDiCjBT1qUjr2SM2xCuROpQKnHr64XxUqaZ4p2eQurmL_4JTt45Wr-Ok5GRTdn/pub?output=csv";
const CSV_URL_VAR = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRwmjzKT5EHJS3McU2_42R-MI6uR4cdm04GeeQ9RBxhprOwSkl9xIx01rZvweCtl3quo2rBNNtNE2AB/pub?output=csv";

// Parser CSV simples que lida com campos entre aspas
function parseCSV(texto) {
  const linhas = [];
  let linhaAtual = [];
  let campo = '';
  let dentroAspas = false;

  for (let i = 0; i < texto.length; i++) {
    let char = texto[i];
    let proximo = texto[i + 1];

    if (dentroAspas) {
      if (char === '"' && proximo === '"') {
        campo += '"';
        i++;
      } else if (char === '"') {
        dentroAspas = false;
      } else {
        campo += char;
      }
    } else {
      if (char === '"') {
        dentroAspas = true;
      } else if (char === ',') {
        linhaAtual.push(campo);
        campo = '';
      } else if (char === '\n' || char === '\r') {
        if (char === '\r' && proximo === '\n') i++;
        linhaAtual.push(campo);
        linhas.push(linhaAtual);
        linhaAtual = [];
        campo = '';
      } else {
        campo += char;
      }
    }
  }

  if (campo || linhaAtual.length > 0) {
    linhaAtual.push(campo);
    linhas.push(linhaAtual);
  }

  return linhas;
}

// Converte string com possível vírgula e % para número
function extrairNumero(valor) {
  if (!valor || valor.trim() === '') return NaN;
  // Remove espaços, substitui vírgula por ponto, remove % se houver
  let str = valor.trim().replace(/\s+/g, '');
  str = str.replace(',', '.');
  str = str.replace('%', '');
  const num = parseFloat(str);
  return isNaN(num) ? NaN : num;
}

function formatarPercentual(valor) {
  if (valor === undefined || valor === null || valor === '') return '-';
  let num;
  if (typeof valor === 'number') {
    num = valor;
  } else {
    num = extrairNumero(valor);
  }
  if (isNaN(num)) return '-';
  return num.toFixed(2) + '%';
}

// Formatar número no estilo brasileiro: 1.234,56
function formatarNumeroBR(num) {
  if (isNaN(num)) return '-';
  return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

async function carregarDados() {
  try {
    // Carregar ambas as planilhas em paralelo
    const [respostaPrincipal, respostaVar] = await Promise.all([
      fetch(CSV_URL_PRINCIPAL),
      fetch(CSV_URL_VAR)
    ]);

    const csvPrincipal = await respostaPrincipal.text();
    const csvVar = await respostaVar.text();

    const csvPrincipalLimpo = csvPrincipal.replace(/^\uFEFF/, '');
    const csvVarLimpo = csvVar.replace(/^\uFEFF/, '');

    const linhasPrincipal = parseCSV(csvPrincipalLimpo);
    const linhasVar = parseCSV(csvVarLimpo);

    const tbody = document.getElementById("tabelaHojeBody");
    tbody.innerHTML = "";

    if (linhasPrincipal.length < 2) {
      tbody.innerHTML = '<tr><td colspan="6">Arquivo principal com poucas linhas</td></tr>';
      return;
    }

    // --- Extrair valor do Ibovespa (linha 198, coluna 1) e calcular variação ---
    let valorIbovespa = NaN;
    let variacaoIbovespa = NaN;

    if (linhasVar.length > 199) { // precisa ter pelo menos até linha 199
      const rawValor198 = linhasVar[198] && linhasVar[198].length > 1 ? linhasVar[198][1] : null;
      const rawValor199 = linhasVar[199] && linhasVar[199].length > 1 ? linhasVar[199][1] : null;
      
      valorIbovespa = extrairNumero(rawValor198);
      const valor199 = extrairNumero(rawValor199);
      
      if (!isNaN(valorIbovespa) && !isNaN(valor199) && valor199 !== 0) {
        variacaoIbovespa = (valorIbovespa / valor199 - 1) * 100; // variação percentual
      }
    }

    // Atualizar quadro
    const ibovespaBox = document.getElementById("ibovespaBox");
    ibovespaBox.innerHTML = `
      <div>Ibovespa Hoje: <span>${formatarNumeroBR(valorIbovespa)}</span></div>
      <div>Variação: <span>${formatarPercentual(variacaoIbovespa)}</span></div>
    `;

    // --- Mapa ação -> setor a partir das colunas 138..268 (linhas 0 e 1) da planilha principal ---
    const acaoParaSetor = {};
    const linhaSetor = linhasPrincipal[0];   // linha 0: setores
    const linhaCodigo = linhasPrincipal[1];  // linha 1: códigos

    for (let col = 138; col <= 268; col++) {
      if (linhaCodigo.length > col && linhaSetor.length > col) {
        const codigo = linhaCodigo[col] ? linhaCodigo[col].trim() : '';
        const setor = linhaSetor[col] ? linhaSetor[col].trim() : '';
        if (codigo !== '' && setor !== '') {
          acaoParaSetor[codigo] = setor;
        }
      }
    }

    // --- Mapa ação -> variação a partir da segunda planilha (coluna 0 -> coluna 1) ---
    const acaoParaVariacao = {};
    // Assume que a primeira linha é cabeçalho (linha 0) e a partir da linha 1 são dados
    for (let i = 1; i < linhasVar.length; i++) {
      const linha = linhasVar[i];
      if (linha.length >= 2) {
        const acao = linha[0] ? linha[0].trim() : '';
        const variacao = linha[1] ? linha[1].trim() : '';
        if (acao !== '' && variacao !== '') {
          acaoParaVariacao[acao] = variacao;
        }
      }
    }

    // --- Preencher a tabela com as ações da planilha principal (todas as linhas, incluindo 0 e 1) ---
    let linhasAdicionadas = 0;

    for (let i = 0; i < linhasPrincipal.length; i++) {
      const linha = linhasPrincipal[i];
      if (linha.length > 300) {
        const acao = linha[300] ? linha[300].trim() : '';
        if (acao !== '') {
          const setor = acaoParaSetor[acao] || '-';
          
          // Peso (coluna 301)
          const pesoRaw = (linha.length > 301 && linha[301]) ? linha[301] : '';
          const pesoNum = extrairNumero(pesoRaw);
          const pesoFormatado = formatarPercentual(pesoNum);
          
          // Variação (segunda planilha)
          const variacaoRaw = acaoParaVariacao[acao] || '';
          const variacaoNum = extrairNumero(variacaoRaw);
          const variacaoFormatada = formatarPercentual(variacaoNum);

          // Contribuição (quinta coluna) = (peso * variação) / 100
          let contribuicaoNum = NaN;
          if (!isNaN(pesoNum) && !isNaN(variacaoNum)) {
            contribuicaoNum = (pesoNum * variacaoNum) / 100;
          }
          const contribuicaoFormatada = formatarPercentual(contribuicaoNum);

          // % da contribuição (sexta coluna) = (contribuição / variaçãoIbovespa) * 100
          let pctContribuicaoNum = NaN;
          if (!isNaN(contribuicaoNum) && !isNaN(variacaoIbovespa) && variacaoIbovespa !== 0) {
            pctContribuicaoNum = (contribuicaoNum / variacaoIbovespa) * 100;
          }
          const pctContribuicaoFormatada = formatarPercentual(pctContribuicaoNum);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${acao}</td>
            <td>${setor}</td>
            <td>${pesoFormatado}</td>
            <td>${variacaoFormatada}</td>
            <td>${contribuicaoFormatada}</td>
            <td>${pctContribuicaoFormatada}</td>
          `;
          tbody.appendChild(tr);
          linhasAdicionadas++;
        }
      }
    }

    if (linhasAdicionadas === 0) {
      tbody.innerHTML = '<tr><td colspan="6">Nenhuma ação encontrada na coluna 300</td></tr>';
    }

  } catch (erro) {
    console.error("Erro ao carregar dados:", erro);
    const tbody = document.getElementById("tabelaHojeBody");
    tbody.innerHTML = '<tr><td colspan="6" style="color:red;">Erro ao carregar dados. Verifique o console.</td></tr>';
    const ibovespaBox = document.getElementById("ibovespaBox");
    ibovespaBox.innerHTML = '<div>Erro ao carregar dados</div>';
  }
}

carregarDados();
</script>

</body>
</html>
