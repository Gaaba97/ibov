<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfico do Ibovespa - Dados em Tempo Real</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .ibovespa-info {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-width: 200px;
            text-align: center;
        }
        
        .info-card h3 {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .info-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .info-card .value.positive {
            color: #27ae60;
        }
        
        .info-card .value.negative {
            color: #e74c3c;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            position: relative;
            height: 500px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.active {
            background-color: #2c3e50;
        }
        
        .data-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .data-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background-color: #ffeaea;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                padding: 15px;
                height: 400px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .info-card {
                min-width: 150px;
                padding: 15px;
            }
            
            .info-card .value {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gráfico do Ibovespa</h1>
            <p class="subtitle">Dados em tempo real da planilha pública do Google Sheets</p>
        </header>
        
        <div class="error" id="error-message">
            <strong>Erro ao carregar dados:</strong> <span id="error-text"></span>
        </div>
        
        <div class="loading" id="loading-indicator">
            <div class="spinner"></div>
            <p>Carregando dados da planilha...</p>
        </div>
        
        <div class="ibovespa-info" id="ibovespa-info" style="display: none;">
            <div class="info-card">
                <h3>Último Valor</h3>
                <div class="value" id="last-value">-</div>
            </div>
            <div class="info-card">
                <h3>Variação (%)</h3>
                <div class="value" id="variation">-</div>
            </div>
            <div class="info-card">
                <h3>Data Atualização</h3>
                <div class="value" id="update-date">-</div>
            </div>
            <div class="info-card">
                <h3>Total de Registros</h3>
                <div class="value" id="total-records">-</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="btn-1m" class="active">1 Mês</button>
            <button id="btn-3m">3 Meses</button>
            <button id="btn-6m">6 Meses</button>
            <button id="btn-1y">1 Ano</button>
            <button id="btn-all">Todo Período</button>
        </div>
        
        <div class="chart-container">
            <canvas id="ibovespa-chart"></canvas>
        </div>
        
        <div class="data-info">
            <h3>Últimos Registros da Planilha</h3>
            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Ibovespa (Pontos)</th>
                            <th>Variação (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Dados serão preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <p>Dados obtidos da planilha pública do Google Sheets | Atualizado em <span id="current-date"></span></p>
            <p>Este gráfico é apenas para fins demonstrativos e não constitui recomendação de investimento.</p>
        </footer>
    </div>

    <script>
        // URL da planilha pública do Google Sheets (formato CSV)
        const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjEpwKbe5Q2Em0ZexDiCjBT1qUjr2SM2xCuROpQKnHr64XxUqaZ4p2eQurmL_4JTt45Wr-Ok5GRTdn/pub?output=csv";
        
        // Variáveis globais
        let ibovespaChart = null;
        let allData = [];
        let filteredData = [];
        
        // Elementos do DOM
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const ibovespaInfo = document.getElementById('ibovespa-info');
        const lastValueElement = document.getElementById('last-value');
        const variationElement = document.getElementById('variation');
        const updateDateElement = document.getElementById('update-date');
        const totalRecordsElement = document.getElementById('total-records');
        const tableBody = document.getElementById('table-body');
        const currentDateElement = document.getElementById('current-date');
        
        // Configurar data atual no rodapé
        const now = new Date();
        currentDateElement.textContent = now.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Função para buscar dados da planilha
        async function fetchSpreadsheetData() {
            try {
                console.log('Iniciando busca de dados...');
                const response = await fetch(SPREADSHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('Dados CSV recebidos, processando...');
                
                // Processar os dados CSV
                processCSVData(csvText);
                
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                showError(`Não foi possível carregar os dados da planilha. Detalhes: ${error.message}`);
                
                // Carregar dados de exemplo em caso de falha
                loadSampleData();
            }
        }
        
        // Função para processar dados CSV
        function processCSVData(csvText) {
            try {
                // Dividir o CSV em linhas
                const lines = csvText.split('\n');
                
                // Procurar pela seção "A. Pontos" - coluna A (Data) e coluna B (Ibovespa)
                let startIndex = -1;
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('A. Pontos') || lines[i].includes('Data') && lines[i].includes('Ibovespa')) {
                        startIndex = i;
                        break;
                    }
                }
                
                // Se não encontrou pelo título, procura por linhas que contenham datas e números
                if (startIndex === -1) {
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].match(/\d{1,2}\/\d{1,2}\/\d{4}/) && lines[i].match(/\d+\.?\d*/)) {
                            startIndex = i;
                            break;
                        }
                    }
                }
                
                // Se ainda não encontrou, usa a partir da segunda linha (supondo que a primeira é cabeçalho)
                if (startIndex === -1) {
                    startIndex = 1;
                }
                
                console.log(`Iniciando processamento a partir da linha ${startIndex + 1}`);
                
                // Processar as linhas de dados
                allData = [];
                
                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Ignorar linhas vazias ou que não contenham dados relevantes
                    if (!line || line.length === 0 || line.startsWith('"') || line.includes('A. Pontos')) {
                        continue;
                    }
                    
                    // Dividir a linha por vírgulas (cuidado com vírgulas dentro de aspas)
                    let columns;
                    
                    // Tentar dividir por vírgula simples
                    if (line.includes('"')) {
                        // Processamento mais complexo para células com aspas
                        columns = parseCSVLine(line);
                    } else {
                        columns = line.split(',');
                    }
                    
                    // Verificar se temos pelo menos duas colunas (Data e Ibovespa)
                    if (columns.length >= 2) {
                        const dateStr = columns[0].trim().replace(/"/g, '');
                        const valueStr = columns[1].trim().replace(/"/g, '');
                        
                        // Validar e converter a data
                        let date;
                        try {
                            // Tentar diferentes formatos de data
                            if (dateStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
                                // Formato DD/MM/YYYY
                                const parts = dateStr.split('/');
                                date = new Date(parts[2], parts[1] - 1, parts[0]);
                            } else if (dateStr.match(/\d{4}-\d{1,2}-\d{1,2}/)) {
                                // Formato YYYY-MM-DD
                                date = new Date(dateStr);
                            } else {
                                // Tentar parse direto
                                date = new Date(dateStr);
                            }
                            
                            // Validar a data
                            if (isNaN(date.getTime())) {
                                console.warn(`Data inválida na linha ${i + 1}: ${dateStr}`);
                                continue;
                            }
                        } catch (e) {
                            console.warn(`Erro ao processar data na linha ${i + 1}: ${dateStr}`, e);
                            continue;
                        }
                        
                        // Validar e converter o valor do Ibovespa
                        const value = parseFloat(valueStr.replace(/\./g, '').replace(',', '.'));
                        
                        if (isNaN(value) || value <= 0) {
                            console.warn(`Valor inválido na linha ${i + 1}: ${valueStr}`);
                            continue;
                        }
                        
                        // Adicionar aos dados
                        allData.push({
                            date: date,
                            dateStr: dateStr,
                            value: value
                        });
                    }
                }
                
                console.log(`Processados ${allData.length} registros válidos.`);
                
                if (allData.length === 0) {
                    throw new Error('Nenhum dado válido encontrado na planilha.');
                }
                
                // Ordenar por data (do mais antigo para o mais recente)
                allData.sort((a, b) => a.date - b.date);
                
                // Calcular variações percentuais
                calculateVariations();
                
                // Mostrar informações resumidas
                updateSummaryInfo();
                
                // Atualizar tabela
                updateTable();
                
                // Inicializar com filtro de 1 mês
                filterDataByMonths(1);
                
                // Ocultar indicador de carregamento e mostrar dados
                loadingIndicator.style.display = 'none';
                ibovespaInfo.style.display = 'flex';
                
            } catch (error) {
                console.error('Erro ao processar dados CSV:', error);
                showError(`Erro ao processar os dados da planilha. ${error.message}`);
                
                // Carregar dados de exemplo em caso de falha
                loadSampleData();
            }
        }
        
        // Função auxiliar para processar linha CSV com aspas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Calcular variações percentuais
        function calculateVariations() {
            for (let i = 1; i < allData.length; i++) {
                const previousValue = allData[i-1].value;
                const currentValue = allData[i].value;
                const variation = ((currentValue - previousValue) / previousValue) * 100;
                allData[i].variation = variation;
            }
            
            // Para o primeiro item, não há variação
            if (allData.length > 0) {
                allData[0].variation = 0;
            }
        }
        
        // Atualizar informações resumidas
        function updateSummaryInfo() {
            if (allData.length === 0) return;
            
            const lastRecord = allData[allData.length - 1];
            const firstRecord = allData[0];
            
            // Último valor
            lastValueElement.textContent = formatNumber(lastRecord.value);
            
            // Variação total
            const totalVariation = ((lastRecord.value - firstRecord.value) / firstRecord.value) * 100;
            variationElement.textContent = `${totalVariation >= 0 ? '+' : ''}${totalVariation.toFixed(2)}%`;
            variationElement.className = `value ${totalVariation >= 0 ? 'positive' : 'negative'}`;
            
            // Data da última atualização
            updateDateElement.textContent = formatDate(lastRecord.date);
            
            // Total de registros
            totalRecordsElement.textContent = allData.length;
        }
        
        // Atualizar tabela com os últimos registros
        function updateTable() {
            // Limpar tabela
            tableBody.innerHTML = '';
            
            // Pegar os últimos 10 registros (do mais recente para o mais antigo)
            const recentData = [...allData].reverse().slice(0, 10);
            
            // Adicionar linhas à tabela
            recentData.forEach(record => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = record.dateStr;
                
                const valueCell = document.createElement('td');
                valueCell.textContent = formatNumber(record.value);
                
                const variationCell = document.createElement('td');
                const variation = record.variation || 0;
                variationCell.textContent = `${variation >= 0 ? '+' : ''}${variation.toFixed(2)}%`;
                variationCell.style.color = variation >= 0 ? '#27ae60' : '#e74c3c';
                
                row.appendChild(dateCell);
                row.appendChild(valueCell);
                row.appendChild(variationCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // Filtrar dados por número de meses
        function filterDataByMonths(months) {
            if (allData.length === 0) return;
            
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - months);
            
            filteredData = allData.filter(record => record.date >= cutoffDate);
            
            // Se não houver dados no período filtrado, usar todos os dados
            if (filteredData.length === 0) {
                filteredData = [...allData];
            }
            
            // Atualizar gráfico
            updateChart();
        }
        
        // Atualizar gráfico com dados filtrados
        function updateChart() {
            if (filteredData.length === 0) return;
            
            const ctx = document.getElementById('ibovespa-chart').getContext('2d');
            
            // Preparar dados para o gráfico
            const labels = filteredData.map(record => formatDate(record.date));
            const values = filteredData.map(record => record.value);
            
            // Configurar cores baseadas na tendência
            const lineColor = values[values.length - 1] >= values[0] ? '#27ae60' : '#e74c3c';
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, lineColor + '40');
            gradient.addColorStop(1, lineColor + '05');
            
            // Se já existe um gráfico, destruir antes de criar um novo
            if (ibovespaChart) {
                ibovespaChart.destroy();
            }
            
            // Criar novo gráfico
            ibovespaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ibovespa (Pontos)',
                        data: values,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                },
                                color: '#2c3e50'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(44, 62, 80, 0.9)',
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 14
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatNumber(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    }
                }
            });
        }
        
        // Formatar número com separadores de milhar
        function formatNumber(num) {
            return num.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Formatar data para exibição
        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Mostrar mensagem de erro
        function showError(message) {
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            loadingIndicator.style.display = 'none';
        }
        
        // Carregar dados de exemplo (em caso de falha na requisição)
        function loadSampleData() {
            console.log('Carregando dados de exemplo...');
            
            // Gerar dados de exemplo para demonstração
            allData = [];
            const startDate = new Date(2023, 0, 1); // 1º de janeiro de 2023
            const baseValue = 100000;
            
            for (let i = 0; i < 365; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                // Valor com variação aleatória
                const randomChange = (Math.random() - 0.5) * 0.03; // Variação de -1.5% a +1.5%
                const value = i === 0 ? baseValue : allData[i-1].value * (1 + randomChange);
                
                allData.push({
                    date: currentDate,
                    dateStr: formatDate(currentDate),
                    value: value
                });
            }
            
            // Calcular variações
            calculateVariations();
            
            // Atualizar informações
            updateSummaryInfo();
            updateTable();
            
            // Inicializar com filtro de 1 mês
            filterDataByMonths(1);
            
            // Ocultar indicador de carregamento e mostrar dados
            loadingIndicator.style.display = 'none';
            ibovespaInfo.style.display = 'flex';
            
            // Mostrar aviso que são dados de exemplo
            showError('Dados de exemplo carregados (não foi possível acessar a planilha online).');
        }
        
        // Configurar eventos dos botões de filtro
        function setupEventListeners() {
            document.getElementById('btn-1m').addEventListener('click', function() {
                setActiveButton(this);
                filterDataByMonths(1);
            });
            
            document.getElementById('btn-3m').addEventListener('click', function() {
                setActiveButton(this);
                filterDataByMonths(3);
            });
            
            document.getElementById('btn-6m').addEventListener('click', function() {
                setActiveButton(this);
                filterDataByMonths(6);
            });
            
            document.getElementById('btn-1y').addEventListener('click', function() {
                setActiveButton(this);
                filterDataByMonths(12);
            });
            
            document.getElementById('btn-all').addEventListener('click', function() {
                setActiveButton(this);
                filteredData = [...allData];
                updateChart();
            });
        }
        
        // Definir botão ativo
        function setActiveButton(activeButton) {
            // Remover classe 'active' de todos os botões
            const buttons = document.querySelectorAll('.controls button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Adicionar classe 'active' ao botão clicado
            activeButton.classList.add('active');
        }
        
        // Inicializar aplicação
        function init() {
            console.log('Inicializando aplicação...');
            setupEventListeners();
            fetchSpreadsheetData();
        }
        
        // Iniciar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
