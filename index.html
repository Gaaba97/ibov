<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Simon</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    /* ... (todos os estilos permanecem iguais) ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- ... (todo o HTML permanece igual) ... -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script>
    const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjEpwKbe5Q2Em0ZexDiCjBT1qUjr2SM2xCuROpQKnHr64XxUqaZ4p2eQurmL_4JTt45Wr-Ok5GRTdn/pub?output=csv";
    
    let ibovespaChart = null;
    let allIbovespaData = [];
    let filteredData = [];
    let weightsMap = null;
    let acoesNames = []; // Array para armazenar nomes das ações (linha 2 da planilha)
    
    const MIN_ALLOWED_DATE = new Date(2024, 11, 29);
    let customTooltip = null;

    // ... (funções createCustomTooltip e showCustomTooltip permanecem iguais) ...

    async function loadIbovespaData() {
      try {
        document.getElementById('subtitle').textContent = 'Carregando dados da planilha...';
        
        const response = await fetch(SPREADSHEET_URL);
        
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        
        const csvText = await response.text();
        processCSVData(csvText);
        
      } catch (error) {
        document.getElementById('subtitle').textContent = 'Erro ao carregar dados da planilha';
        document.getElementById('loadingIndicator').textContent = `Erro: ${error.message}`;
        document.getElementById('loadingIndicator').className = "error";
        loadSampleData();
      }
    }

    async function loadWeightsData() {
      try {
        const response = await fetch(SPREADSHEET_URL);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        
        const csvText = await response.text();
        processWeightsCSVData(csvText);
        
      } catch (error) {
        weightsMap = null;
      }
    }

    function processWeightsCSVData(csvText) {
      try {
        const linhas = csvText.split("\n").map(l => {
          let result = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < l.length; i++) {
            const char = l[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          
          result.push(current);
          return result;
        });
        
        const colunaKW = 308;
        
        const dados = {
          soma5Raw: linhas[1] && linhas[1][colunaKW] ? parseWeightValue(linhas[1][colunaKW]) : 0,
          soma10Raw: linhas[2] && linhas[2][colunaKW] ? parseWeightValue(linhas[2][colunaKW]) : 0,
          soma15Raw: linhas[3] && linhas[3][colunaKW] ? parseWeightValue(linhas[3][colunaKW]) : 0,
          soma20Raw: linhas[4] && linhas[4][colunaKW] ? parseWeightValue(linhas[4][colunaKW]) : 0,
          soma25Raw: linhas[5] && linhas[5][colunaKW] ? parseWeightValue(linhas[5][colunaKW]) : 0,
          soma30Raw: linhas[6] && linhas[6][colunaKW] ? parseWeightValue(linhas[6][colunaKW]) : 0
        };
        
        Object.keys(dados).forEach(key => {
          if (typeof dados[key] !== 'number' || isNaN(dados[key])) {
            dados[key] = 0;
          }
        });
        
        dados.somaRestanteRaw = 100 - dados.soma30Raw;
        weightsMap = dados;

      } catch (error) {
        weightsMap = null;
      }
    }
    
    function parseWeightValue(value) {
      if (!value) return 0;
      
      let cleanValue = value.toString().replace(/"/g, '').trim();
      
      if (!isNaN(cleanValue) && cleanValue !== '') {
        return parseFloat(cleanValue);
      }
      
      if (cleanValue.includes(',')) {
        cleanValue = cleanValue.replace(/\./g, '').replace(',', '.');
        const num = parseFloat(cleanValue);
        return isNaN(num) ? 0 : num;
      }
      
      const num = parseFloat(cleanValue);
      return isNaN(num) ? 0 : num;
    }

    function processCSVData(csvText) {
      try {
        const lines = csvText.split('\n');
        allIbovespaData = [];
        acoesNames = [];
        
        // Encontra a linha de dados (onde começam as datas)
        let startIndex = -1;
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes('A. Pontos') || (lines[i].includes('Data') && lines[i].includes('Ibovespa'))) {
            startIndex = i;
            break;
          }
        }
        
        if (startIndex === -1) {
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].match(/\d{1,2}\/\d{1,2}\/\d{4}/) && lines[i].match(/\d+\.?\d*/)) {
              startIndex = i;
              break;
            }
          }
        }
        
        if (startIndex === -1) startIndex = 1;
        
        // A linha 2 da planilha (índice 1) contém os nomes das ações
        // Vamos extrair os nomes das colunas 139 a 269 da linha 2
        const linhaNomesAcoes = lines[1]; // Linha 2 (índice 1)
        
        if (linhaNomesAcoes) {
          const colunasNomes = parseCSVLine(linhaNomesAcoes);
          
          // Colunas 139 a 269 (índices 138 a 268)
          for (let col = 138; col <= 268 && col < colunasNomes.length; col++) {
            let nomeAcao = colunasNomes[col]?.trim().replace(/"/g, '') || `Coluna ${col + 1}`;
            nomeAcao = nomeAcao.replace(/\s+/g, ' ').trim();
            
            // Limpa o nome - remove qualquer número ou caractere especial no início
            nomeAcao = nomeAcao.replace(/^[\d\s\-\.]+/, '').trim();
            
            if (!nomeAcao || nomeAcao === '') {
              nomeAcao = `Coluna ${col + 1}`;
            }
            
            acoesNames.push(nomeAcao);
          }
        }
        
        // Se não encontrou nomes, cria nomes padrão baseados nas colunas
        if (acoesNames.length === 0) {
          for (let i = 139; i <= 269; i++) {
            acoesNames.push(`Coluna ${i}`);
          }
        }
        
        console.log(`Encontrados ${acoesNames.length} nomes de ações`);
        console.log(acoesNames.slice(0, 10)); // Log dos primeiros 10 nomes para debug
        
        // Agora processa os dados a partir da linha encontrada
        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          
          if (!line || line.length === 0 || line.startsWith('"') || line.includes('A. Pontos')) continue;
          
          let columns = parseCSVLine(line);
          
          if (columns.length >= 2) {
            const dateStr = columns[0].trim().replace(/"/g, '');
            const valueStr = columns[1].trim().replace(/"/g, '');
            
            let date;
            try {
              if (dateStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
                const parts = dateStr.split('/');
                date = new Date(parts[2], parts[1] - 1, parts[0]);
              } else {
                date = new Date(dateStr);
              }
              
              if (isNaN(date.getTime())) continue;
            } catch (e) {
              continue;
            }
            
            const cleanedValue = valueStr.replace(/\./g, '').replace(',', '.');
            const value = parseFloat(cleanedValue);
            
            if (isNaN(value) || value <= 0) continue;
            
            const empresas = [];
            for (let col = 3; col <= 32 && col < columns.length; col++) {
              const empresaValueStr = columns[col]?.trim().replace(/"/g, '') || '0';
              const empresaValue = parseFloat(empresaValueStr.replace(/\./g, '').replace(',', '.'));
              empresas.push(isNaN(empresaValue) ? 0 : empresaValue);
            }
            
            // Processa as ações individuais (colunas 139 a 269)
            const acoesDia = [];
            for (let col = 139; col <= 269 && col < columns.length; col++) {
              const acaoValueStr = columns[col]?.trim().replace(/"/g, '') || '0';
              const acaoValue = parseFloat(acaoValueStr.replace(/\./g, '').replace(',', '.'));
              acoesDia.push(isNaN(acaoValue) ? 0 : acaoValue);
            }
            
            allIbovespaData.push({
              date: date,
              dateStr: dateStr,
              value: value,
              formattedValue: value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
              empresas: empresas,
              acoes: acoesDia
            });
          }
        }
        
        if (allIbovespaData.length === 0) throw new Error('Nenhum dado válido encontrado.');
        
        allIbovespaData.sort((a, b) => a.date - b.date);
        
        const lastRecord = allIbovespaData[allIbovespaData.length - 1];
        document.getElementById('subtitle').textContent = `Última atualização: ${lastRecord.dateStr} - Ibovespa: ${lastRecord.formattedValue} pontos`;
        
        loadWeightsData().then(() => {
          setupDateInputs();
          document.getElementById('periodControls').style.display = 'flex';
          document.getElementById('loadingIndicator').style.display = 'none';
          createMainChart();
          filterDataByMonths(1);
          setupPeriodButtons();
          setupCustomRangeButton();
          setupDateValidation();
        });
        
      } catch (error) {
        console.error('Erro no processamento:', error);
        document.getElementById('subtitle').textContent = 'Erro ao processar dados da planilha';
        document.getElementById('loadingIndicator').textContent = `Erro: ${error.message}`;
        document.getElementById('loadingIndicator').className = "error";
        loadSampleData();
      }
    }
    
    // ... (funções setupDateInputs, setupDateValidation, parseCSVLine, convertToPercentageData, calculateGroupWeights, createMainChart permanecem iguais) ...
    
    function filterDataByMonths(months) {
      if (allIbovespaData.length === 0) return;
      
      const cutoffDate = new Date();
      cutoffDate.setMonth(cutoffDate.getMonth() - months);
      
      filteredData = allIbovespaData.filter(record => record.date >= cutoffDate);
      
      if (filteredData.length === 0) filteredData = [...allIbovespaData];
      
      updateMainChartData();
      updateContributionsTable();
    }
    
    function filterDataByCustomRange(startDate, endDate) {
      if (allIbovespaData.length === 0) return false;
      
      const endDateAdjusted = new Date(endDate);
      endDateAdjusted.setDate(endDateAdjusted.getDate() + 1);
      
      filteredData = allIbovespaData.filter(record => {
        return record.date >= startDate && record.date < endDateAdjusted;
      });
      
      if (filteredData.length === 0) {
        alert('Nenhum dado encontrado para o intervalo selecionado.');
        return false;
      }
      
      updateMainChartData();
      updateContributionsTable();
      
      return true;
    }
    
    function updateMainChartData() {
      if (!ibovespaChart || filteredData.length === 0) return;
      
      ibovespaChart.data.datasets[0].data = convertToPercentageData(filteredData);
      ibovespaChart.update();
    }
    
    function updateContributionsTable() {
      if (filteredData.length < 2) {
        for (let i = 1; i <= 3; i++) {
          document.getElementById(`tableContainer${i}`).style.display = 'none';
          document.getElementById(`tableTitle${i}`).style.display = 'none';
        }
        return;
      }
      
      const valorInicialIbovespa = filteredData[0].value;
      const valorFinalIbovespa = filteredData[filteredData.length - 1].value;
      const variacaoIbovespa = valorFinalIbovespa - valorInicialIbovespa;
      
      if (variacaoIbovespa === 0) {
        for (let i = 1; i <= 3; i++) {
          document.getElementById(`tableContainer${i}`).style.display = 'none';
          document.getElementById(`tableTitle${i}`).style.display = 'none';
        }
        return;
      }
      
      // Tabela 1: Maiores empresas (mantém a lógica original)
      updateTable1(valorInicialIbovespa, valorFinalIbovespa, variacaoIbovespa);
      
      // Tabela 2: Maiores contribuições - Ações individuais
      updateTable2(valorInicialIbovespa, valorFinalIbovespa, variacaoIbovespa);
      
      // Tabela 3: Maiores contribuições - Setores (mantém a mesma lógica da tabela 1)
      updateTable3(valorInicialIbovespa, valorFinalIbovespa, variacaoIbovespa);
    }
    
    function updateTable1(valorInicialIbovespa, valorFinalIbovespa, variacaoIbovespa) {
      const pesos = calculateGroupWeights();
      const variacaoPercentualIbovespa = (variacaoIbovespa / valorInicialIbovespa) * 100;
      
      const grupos = [
        { nome: "5 Maiores Empresas", colInicio: 0, colFim: 4, pesoRaw: pesos.soma5Raw },
        { nome: "10 Maiores Empresas", colInicio: 0, colFim: 9, pesoRaw: pesos.soma10Raw },
        { nome: "15 Maiores Empresas", colInicio: 0, colFim: 14, pesoRaw: pesos.soma15Raw },
        { nome: "20 Maiores Empresas", colInicio: 0, colFim: 19, pesoRaw: pesos.soma20Raw },
        { nome: "25 Maiores Empresas", colInicio: 0, colFim: 24, pesoRaw: pesos.soma25Raw },
        { nome: "30 Maiores Empresas", colInicio: 0, colFim: 29, pesoRaw: pesos.soma30Raw }
      ];
      
      let contribuicao30Maiores = 0;
      let variacao30Maiores = 0;
      
      grupos.forEach(grupo => {
        let somaEmpresas = 0;
        
        for (let i = 1; i < filteredData.length; i++) {
          const registro = filteredData[i];
          if (registro.empresas && registro.empresas.length > 0) {
            for (let j = grupo.colInicio; j <= grupo.colFim && j < registro.empresas.length; j++) {
              somaEmpresas += registro.empresas[j] || 0;
            }
          }
        }
        
        const contribuicaoPercentual = (somaEmpresas / variacaoIbovespa) * 100;
        const variacaoPercentual = (somaEmpresas / valorInicialIbovespa) * 100;
        
        if (grupo.nome === "30 Maiores Empresas") {
          contribuicao30Maiores = contribuicaoPercentual;
          variacao30Maiores = variacaoPercentual;
        }
        
        grupo.contribuicao = contribuicaoPercentual;
        grupo.variacao = variacaoPercentual;
      });
      
      const contribuicaoRestante = 100 - contribuicao30Maiores;
      const variacaoRestante = variacaoPercentualIbovespa - variacao30Maiores;
      
      const tableBody = document.getElementById('contributionsTableBody1');
      tableBody.innerHTML = '';
      
      grupos.forEach(grupo => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="group-cell">${grupo.nome}</td>
          <td class="value-cell" style="color: ${grupo.variacao >= 0 ? '#008000' : '#ff0000'}">
            ${grupo.variacao >= 0 ? '+' : ''}${grupo.variacao.toFixed(2)}%
          </td>
          <td class="value-cell" style="color: ${grupo.contribuicao >= 0 ? '#008000' : '#ff0000'}">
            ${grupo.contribuicao >= 0 ? '+' : ''}${grupo.contribuicao.toFixed(2)}%
          </td>
          <td class="value-cell" style="color: #1E4DB7">
            ${grupo.pesoRaw.toFixed(2)}%
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      const restanteRow = document.createElement('tr');
      restanteRow.innerHTML = `
        <td class="group-cell">Restante</td>
        <td class="value-cell" style="color: ${variacaoRestante >= 0 ? '#008000' : '#ff0000'}">
          ${variacaoRestante >= 0 ? '+' : ''}${variacaoRestante.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: ${contribuicaoRestante >= 0 ? '#008000' : '#ff0000'}">
          ${contribuicaoRestante >= 0 ? '+' : ''}${contribuicaoRestante.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: #1E4DB7">
          ${pesos.somaRestanteRaw.toFixed(2)}%
        </td>
      `;
      tableBody.appendChild(restanteRow);
      
      const ibovespaRow = document.createElement('tr');
      ibovespaRow.style.backgroundColor = '#f0f5ff';
      ibovespaRow.style.fontWeight = 'bold';
      ibovespaRow.innerHTML = `
        <td class="group-cell" style="color: #1E4DB7; font-weight: bold;">Ibovespa</td>
        <td class="value-cell" style="color: ${variacaoPercentualIbovespa >= 0 ? '#008000' : '#ff0000'}; font-weight: bold;">
          ${variacaoPercentualIbovespa >= 0 ? '+' : ''}${variacaoPercentualIbovespa.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
          100.00%
        </td>
        <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
          100.00%
        </td>
      `;
      tableBody.appendChild(ibovespaRow);
      
      document.getElementById('tableContainer1').style.display = 'block';
      document.getElementById('tableTitle1').style.display = 'block';
    }
    
    function updateTable2(valorInicialIbovespa, valorFinalIbovespa, variacaoIbovespa) {
      const variacaoPercentualIbovespa = (variacaoIbovespa / valorInicialIbovespa) * 100;
      
      // Calcula a contribuição de cada ação individual (colunas 139-269)
      const contribuicoesAcoes = [];
      
      // Para cada ação (0-130, correspondendo às colunas 139-269)
      for (let acaoIndex = 0; acaoIndex < 131; acaoIndex++) {
        let somaAcao = 0;
        
        // Soma a contribuição desta ação em todos os dias do período
        for (let i = 1; i < filteredData.length; i++) {
          const registro = filteredData[i];
          if (registro.acoes && registro.acoes.length > acaoIndex) {
            somaAcao += registro.acoes[acaoIndex] || 0;
          }
        }
        
        // Calcula os percentuais
        const variacaoPercentualAcao = (somaAcao / valorInicialIbovespa) * 100;
        const contribuicaoPercentualAcao = (somaAcao / variacaoIbovespa) * 100;
        
        contribuicoesAcoes.push({
          nome: acoesNames[acaoIndex] || `Coluna ${139 + acaoIndex}`,
          somaPontos: somaAcao,
          variacaoPercentual: variacaoPercentualAcao,
          contribuicaoPercentual: contribuicaoPercentualAcao,
          indice: acaoIndex
        });
      }
      
      // Ordena por contribuição em pontos (da maior para a menor)
      contribuicoesAcoes.sort((a, b) => b.somaPontos - a.somaPontos);
      
      // Pega as 7 maiores contribuições
      const top7Acoes = contribuicoesAcoes.slice(0, 7);
      
      const tableBody = document.getElementById('contributionsTableBody2');
      tableBody.innerHTML = '';
      
      // Adiciona as 7 ações
      top7Acoes.forEach(acao => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="group-cell">${acao.nome}</td>
          <td class="value-cell" style="color: ${acao.variacaoPercentual >= 0 ? '#008000' : '#ff0000'}">
            ${acao.variacaoPercentual >= 0 ? '+' : ''}${acao.variacaoPercentual.toFixed(2)}%
          </td>
          <td class="value-cell" style="color: ${acao.contribuicaoPercentual >= 0 ? '#008000' : '#ff0000'}">
            ${acao.contribuicaoPercentual >= 0 ? '+' : ''}${acao.contribuicaoPercentual.toFixed(2)}%
          </td>
          <td class="value-cell" style="color: #1E4DB7">
            -
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      // Adiciona o Ibovespa como 8ª linha
      const ibovespaRow = document.createElement('tr');
      ibovespaRow.style.backgroundColor = '#f0f5ff';
      ibovespaRow.style.fontWeight = 'bold';
      ibovespaRow.innerHTML = `
        <td class="group-cell" style="color: #1E4DB7; font-weight: bold;">Ibovespa</td>
        <td class="value-cell" style="color: ${variacaoPercentualIbovespa >= 0 ? '#008000' : '#ff0000'}; font-weight: bold;">
          ${variacaoPercentualIbovespa >= 0 ? '+' : ''}${variacaoPercentualIbovespa.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
          100.00%
        </td>
        <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
          100.00%
        </td>
      `;
      tableBody.appendChild(ibovespaRow);
      
      document.getElementById('tableContainer2').style.display = 'block';
      document.getElementById('tableTitle2').style.display = 'block';
    }
    
    function updateTable3(valorInicialIbovespa, valorFinalIbovespa, variacaoIbovespa) {
      const pesos = calculateGroupWeights();
      const variacaoPercentualIbovespa = (variacaoIbovespa / valorInicialIbovespa) * 100;
      
      const grupos = [
        { nome: "5 Maiores Empresas", colInicio: 0, colFim: 4, pesoRaw: pesos.soma5Raw },
        { nome: "10 Maiores Empresas", colInicio: 0, colFim: 9, pesoRaw: pesos.soma10Raw },
        { nome: "15 Maiores Empresas", colInicio: 0, colFim: 14, pesoRaw: pesos.soma15Raw },
        { nome: "20 Maiores Empresas", colInicio: 0, colFim: 19, pesoRaw: pesos.soma20Raw },
        { nome: "25 Maiores Empresas", colInicio: 0, colFim: 24, pesoRaw: pesos.soma25Raw },
        { nome: "30 Maiores Empresas", colInicio: 0, colFim: 29, pesoRaw: pesos.soma30Raw }
      ];
      
      let contribuicao30Maiores = 0;
      let variacao30Maiores = 0;
      
      grupos.forEach(grupo => {
        let somaEmpresas = 0;
        
        for (let i = 1; i < filteredData.length; i++) {
          const registro = filteredData[i];
          if (registro.empresas && registro.empresas.length > 0) {
            for (let j = grupo.colInicio; j <= grupo.colFim && j < registro.empresas.length; j++) {
              somaEmpresas += registro.empresas[j] || 0;
            }
          }
        }
        
        const contribuicaoPercentual = (somaEmpresas / variacaoIbovespa) * 100;
        const variacaoPercentual = (somaEmpresas / valorInicialIbovespa) * 100;
        
        if (grupo.nome === "30 Maiores Empresas") {
          contribuicao30Maiores = contribuicaoPercentual;
          variacao30Maiores = variacaoPercentual;
        }
        
        grupo.contribuicao = contribuicaoPercentual;
        grupo.variacao = variacaoPercentual;
      });
      
      const contribuicaoRestante = 100 - contribuicao30Maiores;
      const variacaoRestante = variacaoPercentualIbovespa - variacao30Maiores;
      
      const tableBody = document.getElementById('contributionsTableBody3');
      tableBody.innerHTML = '';
      
      grupos.forEach(grupo => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="group-cell">${grupo.nome}</td>
          <td class="value-cell" style="color: ${grupo.variacao >= 0 ? '#008000' : '#ff0000'}">
            ${grupo.variacao >= 0 ? '+' : ''}${grupo.variacao.toFixed(2)}%
          </td>
          <td class="value-cell" style="color: ${grupo.contribuicao >= 0 ? '#008000' : '#ff0000'}">
            ${grupo.contribuicao >= 0 ? '+' : ''}${grupo.contribuicao.toFixed(2)}%
          </td>
          <td class="value-cell" style="color: #1E4DB7">
            ${grupo.pesoRaw.toFixed(2)}%
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      const restanteRow = document.createElement('tr');
      restanteRow.innerHTML = `
        <td class="group-cell">Restante</td>
        <td class="value-cell" style="color: ${variacaoRestante >= 0 ? '#008000' : '#ff0000'}">
          ${variacaoRestante >= 0 ? '+' : ''}${variacaoRestante.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: ${contribuicaoRestante >= 0 ? '#008000' : '#ff0000'}">
          ${contribuicaoRestante >= 0 ? '+' : ''}${contribuicaoRestante.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: #1E4DB7">
          ${pesos.somaRestanteRaw.toFixed(2)}%
        </td>
      `;
      tableBody.appendChild(restanteRow);
      
      const ibovespaRow = document.createElement('tr');
      ibovespaRow.style.backgroundColor = '#f0f5ff';
      ibovespaRow.style.fontWeight = 'bold';
      ibovespaRow.innerHTML = `
        <td class="group-cell" style="color: #1E4DB7; font-weight: bold;">Ibovespa</td>
        <td class="value-cell" style="color: ${variacaoPercentualIbovespa >= 0 ? '#008000' : '#ff0000'}; font-weight: bold;">
          ${variacaoPercentualIbovespa >= 0 ? '+' : ''}${variacaoPercentualIbovespa.toFixed(2)}%
        </td>
        <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
          100.00%
        </td>
        <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
          100.00%
        </td>
      `;
      tableBody.appendChild(ibovespaRow);
      
      document.getElementById('tableContainer3').style.display = 'block';
      document.getElementById('tableTitle3').style.display = 'block';
    }
    
    // ... (funções setupPeriodButtons, setupCustomRangeButton, loadSampleData, init permanecem iguais) ...

    function loadSampleData() {
      allIbovespaData = [];
      acoesNames = [];
      
      // Cria nomes genéricos para as colunas 139-269
      for (let i = 139; i <= 269; i++) {
        acoesNames.push(`Coluna ${i}`);
      }
      
      const startDate = new Date(2023, 0, 1);
      const baseValue = 100000;
      
      for (let i = 0; i < 365; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const randomChange = (Math.random() - 0.5) * 0.03;
        const value = i === 0 ? baseValue : allIbovespaData[i-1].value * (1 + randomChange);
        
        const empresas = [];
        for (let j = 0; j < 30; j++) {
          empresas.push(1000 + Math.random() * 4000);
        }
        
        const acoes = [];
        for (let j = 0; j < 131; j++) {
          acoes.push(100 + Math.random() * 400);
        }
        
        allIbovespaData.push({
          date: currentDate,
          dateStr: currentDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }),
          value: value,
          formattedValue: value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
          empresas: empresas,
          acoes: acoes
        });
      }
      
      const lastRecord = allIbovespaData[allIbovespaData.length - 1];
      document.getElementById('subtitle').textContent = `DADOS DE EXEMPLO - Última atualização: ${lastRecord.dateStr} - Ibovespa: ${lastRecord.formattedValue} pontos`;
      
      weightsMap = null;
      setupDateInputs();
      document.getElementById('periodControls').style.display = 'flex';
      document.getElementById('loadingIndicator').style.display = 'none';
      createMainChart();
      filterDataByMonths(1);
      setupPeriodButtons();
      setupCustomRangeButton();
      setupDateValidation();
    }
    
    function init() {
      window.addEventListener('resize', () => {
        if (ibovespaChart) ibovespaChart.resize();
      });
      loadIbovespaData();
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
