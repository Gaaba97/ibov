<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Performance Ibov</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-62WVY9D4XQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-62WVY9D4XQ');
  </script>
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    /* ----- NOVA NAVBAR PRETA (links à direita) ----- */
    .navbar {
      background-color: #000;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 30px;
      font-family: "Montserrat", sans-serif;
      font-size: 16px;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.2s ease;
    }
    .navbar a:hover {
      opacity: 0.8;
    }
    /* ----- FIM DA NAVBAR NOVA ----- */

    /* ESTILOS – mantidos exatamente iguais ao original */
    html, body {
      margin: 0;
      padding: 0;
      background-color: #fff;
      font-family: "DM Sans", sans-serif;
      color: #000;
      height: 100%;
      overflow-y: auto;
    }

    .container {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
    }

    .header-info {
      width: 95%;
      max-width: 1200px;
      text-align: center;
      margin-bottom: 25px;
    }

    .header-info h1 {
      font-size: 24px;
      color: #1E4DB7;
      margin: 0 0 5px 0;
    }

    .subtitle {
      font-size: 14px;
      color: #555;
      margin: 0;
    }

    .chart-main-container {
      width: 95%;
      max-width: 1200px;
      height: auto;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      margin-bottom: 30px;
    }

    .chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 400px;
      background-color: #fff;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
    }

    canvas {
      width: 100%;
      height: 100% !important;
    }

    .period-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      width: 100%;
      flex-wrap: wrap;
    }

    .period-btn {
      padding: 8px 16px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .period-btn:hover {
      background-color: #e0e0e0;
    }

    .period-btn.active {
      background-color: #164CAD;
      color: white;
      border-color: #164CAD;
    }

    .custom-range-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 20px;
      padding: 8px 12px;
      background-color: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .custom-range-container label {
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
    }

    .date-input {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      width: 120px;
    }

    .apply-btn {
      padding: 6px 12px;
      background-color: #164CAD;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }

    .apply-btn:hover {
      background-color: #0d3a8a;
    }

    .date-error {
      position: absolute;
      top: 100%;
      left: 0;
      color: #ff0000;
      font-size: 11px;
      font-family: "Montserrat", sans-serif;
      margin-top: 2px;
      display: none;
      background: white;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #ff0000;
      z-index: 10;
      white-space: nowrap;
    }

    .date-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .loading {
      color: #666;
      font-style: italic;
      font-size: 16px;
      text-align: center;
      margin-top: 20px;
    }

    .error {
      color: #ff0000;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }

    .custom-tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #164CAD;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      pointer-events: none;
      z-index: 100;
      font-family: "Montserrat", sans-serif;
      backdrop-filter: blur(5px);
      transition: opacity 0.2s ease;
      opacity: 0;
    }

    .custom-tooltip.visible {
      opacity: 1;
    }

    .custom-tooltip::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .custom-tooltip.top::before {
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px 8px 0 8px;
      border-color: #164CAD transparent transparent transparent;
    }

    .tooltip-header {
      font-weight: 550;
      color: #000;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
    }

    .tooltip-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .tooltip-label {
      display: flex;
      align-items: center;
      color: #000;
    }

    .tooltip-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }

    .tooltip-value {
      font-weight: 400;
      color: #000;
      margin-left: 12px;
    }

    .tables-wrapper {
      width: 95%;
      max-width: 1400px;
      display: flex;
      gap: 20px;
      margin-top: 40px;
      margin-bottom: 40px;
      justify-content: space-between;
    }

    .table-container {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .contributions-table {
      width: 100%;
      border-collapse: collapse;
      font-family: "Montserrat", sans-serif;
      font-size: 13px;
      table-layout: fixed;
    }

    .contributions-table th {
      background-color: #164CAD;
      color: white;
      font-weight: 500;
      text-align: center;
      padding: 12px 8px;
      white-space: normal;
      word-break: normal;
      overflow-wrap: normal;
      line-height: 1.2;
      height: 50px;
    }

    .contributions-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #e0e0e0;
      text-align: center;
      word-wrap: break-word;
      height: 40px;
      vertical-align: middle;
    }

    .contributions-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .contributions-table tbody tr:hover {
      background-color: #f0f5ff;
    }

    .contributions-table .group-cell {
      font-weight: 500;
      color: #164CAD;
      text-align: left;
    }

    .contributions-table .value-cell {
      text-align: center;
      font-weight: 500;
      font-family: "DM Sans", sans-serif;
    }

    .contributions-table th:nth-child(1),
    .contributions-table td:nth-child(1) {
      width: 35%;
    }

    .contributions-table th:nth-child(2),
    .contributions-table td:nth-child(2) {
      width: 20%;
    }

    .contributions-table th:nth-child(3),
    .contributions-table td:nth-child(3) {
      width: 20%;
    }

    .contributions-table th:nth-child(4),
    .contributions-table td:nth-child(4) {
      width: 25%;
    }

    .table-title {
      width: 100%;
      text-align: center;
      margin-top: 40px;
      margin-bottom: 15px;
      font-family: "Montserrat", sans-serif;
      font-size: 16px;
      color: #1E4DB7;
      font-weight: 500;
      display: none;
    }

    .table-section {
      width: 32%;
      display: flex;
      flex-direction: column;
    }

    /* --- REGRAS PARA DISPOSITIVOS TOUCH (adaptado) --- */
    .touch-device {
      font-size: 18px;
    }

    .touch-device .navbar {
      font-size: 18px;
    }

    /* Remove o botão "3 Meses" em touch */
    .touch-device .period-btn[data-period="3m"] {
      display: none;
    }

    .touch-device .period-btn {
      font-size: 16px;
      padding: 10px 18px;
    }

    .touch-device .contributions-table {
      font-size: 15px;
    }

    .touch-device .contributions-table th,
    .touch-device .contributions-table td {
      padding: 14px 10px;
    }

    .touch-device .table-title {
      font-size: 18px;
    }

    .touch-device .header-info h1 {
      font-size: 28px;
    }

    .touch-device .subtitle {
      font-size: 16px;
    }

    /* Botões de período: em linha com rolagem horizontal */
    .touch-device .period-controls {
      flex-wrap: nowrap;
      overflow-x: auto;
      justify-content: flex-start;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }

    .touch-device .period-btn {
      flex-shrink: 0;
    }

    /* Seletor de data personalizado: mesmo estilo dos botões */
    .touch-device .custom-range-container {
      margin-left: 0;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px 18px; /* mesmo padding dos botões */
      gap: 12px;
      flex-shrink: 0; /* não encolhe */
    }

    .touch-device .custom-range-container label {
      font-size: 16px;
      color: #333;
    }

    .touch-device .date-input {
      font-size: 16px;
      padding: 8px 12px;
      width: 130px; /* um pouco maior para caber melhor */
      border: 1px solid #ccc;
    }

    .touch-device .apply-btn {
      font-size: 16px;
      padding: 8px 16px;
    }

    .touch-device .tables-wrapper {
      flex-wrap: wrap;
      justify-content: center;
    }

    .touch-device .table-section {
      width: 100%;
      margin-bottom: 20px;
    }
    /* ------------------------------------------------ */
  </style>
</head>
<body>
  <!-- NOVA NAVBAR PRETA (links à direita) -->
  <nav class="navbar">
    <a href="index.html">Histórico</a>
    <a href="hoje.html">Hoje</a>
  </nav>

  <div class="container">
    <div class="header-info">
      <h1>Ibovespa - Atribuição de Performance</h1>
      <div class="subtitle" id="subtitle">Carregando dados...</div>
    </div>
    
    <div class="chart-main-container">
      <div class="chart-container">
        <canvas id="ibovespaChart"></canvas>
      </div>
      <div class="period-controls" id="periodControls">
        <button class="period-btn active" data-period="1m">1 Mês</button>
        <button class="period-btn" data-period="3m">3 Meses</button>
        <button class="period-btn" data-period="6m">6 Meses</button>
        <button class="period-btn" data-period="1y">1 Ano</button>
        <button class="period-btn" data-period="all">Todo Período</button>
        
        <div class="custom-range-container">
          <label for="startDate">De:</label>
          <div class="date-input-wrapper">
            <input type="date" id="startDate" class="date-input">
            <div id="startDateError" class="date-error"></div>
          </div>
          
          <label for="endDate">Até:</label>
          <div class="date-input-wrapper">
            <input type="date" id="endDate" class="date-input">
            <div id="endDateError" class="date-error"></div>
          </div>
          
          <button id="applyCustomRange" class="apply-btn">Aplicar</button>
        </div>
      </div>
      <div class="loading" id="loadingIndicator">Carregando gráfico...</div>
    </div>

    <div class="tables-wrapper" id="tablesWrapper">
      <div class="table-section">
        <div class="table-title" id="tableTitle1">Maiores empresas</div>
        <div class="table-container" id="tableContainer1">
          <table class="contributions-table">
            <thead>
              <tr>
                <th>Grupo de Empresas</th>
                <th>Variação<br>(%)</th>
                <th>Contribuição<br>(%)</th>
                <th>Peso Atual<br>(%)</th>
              </tr>
            </thead>
            <tbody id="contributionsTableBody1"></tbody>
          </table>
        </div>
      </div>

      <div class="table-section">
        <div class="table-title" id="tableTitle2">Maiores contribuições - Ações</div>
        <div class="table-container" id="tableContainer2">
          <table class="contributions-table">
            <thead>
              <tr>
                <th>Empresa/Ação</th>
                <th>Variação<br>(%)</th>
                <th>Contribuição<br>(%)</th>
                <th>Peso Atual<br>(%)</th>
              </tr>
            </thead>
            <tbody id="contributionsTableBody2"></tbody>
          </table>
        </div>
      </div>

      <div class="table-section">
        <div class="table-title" id="tableTitle3">Maiores contribuições - Setores</div>
        <div class="table-container" id="tableContainer3">
          <table class="contributions-table">
            <thead>
              <tr>
                <th>Setor</th>
                <th>Variação<br>(%)</th>
                <th>Contribuição<br>(%)</th>
                <th>Peso Atual<br>(%)</th>
              </tr>
            </thead>
            <tbody id="contributionsTableBody3"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (opcional) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMfMIXZP4FE2K0Ux3-mZfyRSsXs-ffqxw",
      authDomain: "ibovespa-ae47d.firebaseapp.com",
      projectId: "ibovespa-ae47d",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    console.log("Firebase inicializado com projeto:", firebaseConfig.projectId);
  </script>

  <!-- Bibliotecas auxiliares -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <!-- Script principal da aplicação (agora com a lógica de ordenação condicional) -->
  <script>
    // --- DETECÇÃO DE DISPOSITIVO TOUCH ---
    (function() {
      const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      if (isTouchDevice) {
        document.body.classList.add('touch-device');
      }
    })();

    // Configuração
    const API_URL = "https://us-central1-ibovespa-ae47d.cloudfunctions.net/api/dados";
    const MIN_ALLOWED_DATE = new Date(2024, 11, 29);

    let ibovespaChart = null;
    let chartDataCache = []; // usado para o tooltip

    // Elementos do DOM
    const subtitleEl = document.getElementById('subtitle');
    const loadingEl = document.getElementById('loadingIndicator');
    const periodControls = document.getElementById('periodControls');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const startDateError = document.getElementById('startDateError');
    const endDateError = document.getElementById('endDateError');
    const applyBtn = document.getElementById('applyCustomRange');
    const periodBtns = document.querySelectorAll('.period-btn');

    // Tooltip customizado
    let customTooltip = null;

    function createCustomTooltip() {
      if (customTooltip) return customTooltip;
      customTooltip = document.createElement('div');
      customTooltip.className = 'custom-tooltip';
      document.querySelector('.chart-main-container').appendChild(customTooltip);
      return customTooltip;
    }

    function showCustomTooltip(chart, tooltip) {
      const tooltipEl = createCustomTooltip();
      if (tooltip.opacity === 0) {
        tooltipEl.classList.remove('visible');
        return;
      }

      if (tooltip.body) {
        const title = tooltip.title[0] || '';
        const dataPoint = tooltip.dataPoints[0];
        const dataset = chart.data.datasets[dataPoint.datasetIndex];
        const pointIndex = dataPoint.dataIndex;
        const originalValue = chartDataCache[pointIndex]?.value || 0;
        const percentValue = dataPoint.raw.y;
        const color = dataset.borderColor || '#164CAD';

        tooltipEl.innerHTML = `
          <div class="tooltip-header">${title}</div>
          <div class="tooltip-item">
            <span class="tooltip-label">
              <span class="tooltip-color" style="background-color: ${color}"></span>
              ${dataset.label || 'Ibovespa'}
            </span>
          </div>
          <div class="tooltip-item">
            <span class="tooltip-label">Variação:</span>
            <span class="tooltip-value" style="color: ${percentValue >= 0 ? '#008000' : '#ff0000'}">
              ${percentValue >= 0 ? '+' : ''}${percentValue.toFixed(2)}%
            </span>
          </div>
          <div class="tooltip-item">
            <span class="tooltip-label">Valor:</span>
            <span class="tooltip-value">${originalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} pontos</span>
          </div>
        `;
      }

      const position = chart.canvas.getBoundingClientRect();
      const chartContainer = document.querySelector('.chart-main-container');
      const containerRect = chartContainer.getBoundingClientRect();
      
      let left = position.left + tooltip.caretX - containerRect.left;
      let top = position.top + tooltip.caretY - containerRect.top;
      
      const tooltipWidth = tooltipEl.offsetWidth;
      const tooltipHeight = tooltipEl.offsetHeight;
      
      if (top - tooltipHeight - 10 < 0) {
        top += 20;
      } else {
        top -= tooltipHeight + 10;
      }
      
      if (left + tooltipWidth > containerRect.width) {
        left = containerRect.width - tooltipWidth - 10;
      } else if (left < 0) {
        left = 10;
      } else {
        left -= tooltipWidth / 2;
      }
      
      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      tooltipEl.className = 'custom-tooltip top visible';
    }

    // Função principal: carrega dados da API
    async function carregarDados(params = { periodo: '1m' }) {
      try {
        loadingEl.style.display = 'block';
        loadingEl.className = 'loading';
        loadingEl.textContent = 'Carregando dados...';

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Erro ${response.status}: ${errorText}`);
        }

        const dados = await response.json();

        // Atualiza subtítulo
        subtitleEl.textContent = `Última atualização: ${dados.ultimaData} - Ibovespa: ${dados.ultimoValor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} pontos`;

        // Atualiza gráfico
        atualizarGrafico(dados.chartData);

       // --- ORDENAÇÃO CONDICIONAL DAS TABELAS 2 E 3 ---
// Calcula a variação do Ibovespa no período
let variacaoIbov = 0;
if (dados.chartData && dados.chartData.length >= 2) {
    const primeiro = dados.chartData[0].y;
    const ultimo = dados.chartData[dados.chartData.length - 1].y;
    variacaoIbov = ultimo - primeiro;
    console.log('Variação do Ibovespa no período:', variacaoIbov);
}

// Prepara as tabelas (cópia para não modificar o original)
let tabela1 = dados.tabela1 || [];
let tabela2 = dados.tabela2 || [];
let tabela3 = dados.tabela3 || [];

// Se a variação for negativa, ordena as tabelas 2 e 3 pela contribuição em ordem crescente (mais negativa primeiro)
if (variacaoIbov < 0) {
    console.log('Variação negativa: ordenando de forma crescente (menor contribuição primeiro)');
    tabela2 = [...tabela2].sort((a, b) => a.contribuicao - b.contribuicao);
    tabela3 = [...tabela3].sort((a, b) => a.contribuicao - b.contribuicao);
} else {
    // Opcional: se quiser garantir ordem decrescente quando a variação for zero ou positiva
    // Descomente as linhas abaixo:
    // tabela2 = [...tabela2].sort((a, b) => b.contribuicao - a.contribuicao);
    // tabela3 = [...tabela3].sort((a, b) => b.contribuicao - a.contribuicao);
}

// Atualiza as tabelas
preencherTabela1(tabela1);
preencherTabela2(tabela2);
preencherTabela3(tabela3);
        // --- FIM DA MODIFICAÇÃO ---

        loadingEl.style.display = 'none';
      } catch (error) {
        console.error(error);
        loadingEl.className = 'error';
        loadingEl.textContent = `Erro ao carregar dados: ${error.message}`;
      }
    }

    // Funções de renderização (inalteradas)
    function atualizarGrafico(chartData) {
      chartDataCache = chartData; // guarda para o tooltip

      if (!ibovespaChart) {
        const ctx = document.getElementById('ibovespaChart').getContext('2d');
        const createGradient = (ctx, chartArea) => {
          const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
          gradient.addColorStop(0, "#F6F8FC");
          gradient.addColorStop(0.5, "#8EA8D7");
          gradient.addColorStop(1, "#164CAD");
          return gradient;
        };

        ibovespaChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Ibovespa',
              data: chartData,
              borderColor: '#164CAD',
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.15,
              fill: true,
              backgroundColor: (context) => {
                const chart = context.chart;
                const { ctx, chartArea } = chart;
                if (!chartArea) return null;
                return createGradient(ctx, chartArea);
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  usePointStyle: true,
                  pointStyle: 'circle',
                  color: '#000000',
                  font: { family: 'Montserrat', size: 14, weight: '300' }
                }
              },
              tooltip: { enabled: false, external: (context) => showCustomTooltip(context.chart, context.tooltip) }
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'month',
                  displayFormats: { month: 'MMM - yy' },
                  tooltipFormat: 'dd/MM/yyyy'
                },
                ticks: {
                  color: '#000000',
                  maxRotation: 45,
                  minRotation: 45,
                  font: { family: 'Montserrat', size: 12, weight: '300' },
                  callback: function(value) {
                    const date = new Date(value);
                    const month = date.getMonth();
                    const year = date.getFullYear().toString().slice(-2);
                    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                    return `${meses[month]} - ${year}`;
                  }
                },
                grid: { color: 'rgba(0,0,0,0.05)' }
              },
              y: {
                ticks: {
                  color: '#000000',
                  font: { family: 'Montserrat', size: 12, weight: '300' },
                  callback: (v) => `${v.toFixed(1)}%`
                },
                grid: { color: 'rgba(0,0,0,0.05)' },
                title: {
                  display: true,
                  text: 'Variação Percentual (%)',
                  color: '#000000',
                  font: { family: 'Montserrat', size: 12, weight: '300' }
                }
              }
            }
          }
        });
      } else {
        ibovespaChart.data.datasets[0].data = chartData;
        ibovespaChart.update();
      }
    }

    function preencherTabela1(linhas) {
      const tbody = document.getElementById('contributionsTableBody1');
      tbody.innerHTML = '';
      if (!linhas || linhas.length === 0) {
        document.getElementById('tableContainer1').style.display = 'none';
        document.getElementById('tableTitle1').style.display = 'none';
        return;
      }
      linhas.forEach(l => {
        const tr = document.createElement('tr');
        if (l.destaque) tr.style.backgroundColor = '#f0f5ff';
        tr.innerHTML = `
          <td class="group-cell">${l.nome}</td>
          <td class="value-cell" style="color: ${l.variacao >= 0 ? '#008000' : '#ff0000'}">${l.variacao >= 0 ? '+' : ''}${l.variacao.toFixed(2)}%</td>
          <td class="value-cell" style="color: ${l.contribuicao >= 0 ? '#008000' : '#ff0000'}">${l.contribuicao >= 0 ? '+' : ''}${l.contribuicao.toFixed(2)}%</td>
          <td class="value-cell" style="color: #1E4DB7">${typeof l.peso === 'number' ? l.peso.toFixed(2)+'%' : l.peso}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('tableContainer1').style.display = 'block';
      document.getElementById('tableTitle1').style.display = 'block';
    }

    function preencherTabela2(linhas) {
      const tbody = document.getElementById('contributionsTableBody2');
      tbody.innerHTML = '';
      if (!linhas || linhas.length === 0) {
        document.getElementById('tableContainer2').style.display = 'none';
        document.getElementById('tableTitle2').style.display = 'none';
        return;
      }
      linhas.forEach(l => {
        const tr = document.createElement('tr');
        if (l.destaque) tr.style.backgroundColor = '#f0f5ff';
        tr.innerHTML = `
          <td class="group-cell">${l.nome}</td>
          <td class="value-cell" style="color: ${l.variacao >= 0 ? '#008000' : '#ff0000'}">${l.variacao >= 0 ? '+' : ''}${l.variacao.toFixed(2)}%</td>
          <td class="value-cell" style="color: ${l.contribuicao >= 0 ? '#008000' : '#ff0000'}">${l.contribuicao >= 0 ? '+' : ''}${l.contribuicao.toFixed(2)}%</td>
          <td class="value-cell" style="color: #1E4DB7">${l.peso}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('tableContainer2').style.display = 'block';
      document.getElementById('tableTitle2').style.display = 'block';
    }

    function preencherTabela3(linhas) {
      const tbody = document.getElementById('contributionsTableBody3');
      tbody.innerHTML = '';
      if (!linhas || linhas.length === 0) {
        document.getElementById('tableContainer3').style.display = 'none';
        document.getElementById('tableTitle3').style.display = 'none';
        return;
      }
      linhas.forEach(l => {
        const tr = document.createElement('tr');
        if (l.destaque) tr.style.backgroundColor = '#f0f5ff';
        tr.innerHTML = `
          <td class="group-cell">${l.nome}</td>
          <td class="value-cell" style="color: ${l.variacao >= 0 ? '#008000' : '#ff0000'}">${l.variacao >= 0 ? '+' : ''}${l.variacao.toFixed(2)}%</td>
          <td class="value-cell" style="color: ${l.contribuicao >= 0 ? '#008000' : '#ff0000'}">${l.contribuicao >= 0 ? '+' : ''}${l.contribuicao.toFixed(2)}%</td>
          <td class="value-cell" style="color: #1E4DB7">${l.peso}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('tableContainer3').style.display = 'block';
      document.getElementById('tableTitle3').style.display = 'block';
    }

    // Configuração dos inputs de data (validação e valores iniciais)
    function setupDateInputs() {
      const hoje = new Date();
      const umMesAtras = new Date(hoje);
      umMesAtras.setMonth(hoje.getMonth() - 1);

      const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

      startDateInput.value = formatDate(umMesAtras);
      endDateInput.value = formatDate(hoje);
    }

    function setupDateValidation() {
      startDateInput.addEventListener('change', function() {
        const selected = new Date(this.value);
        if (selected < MIN_ALLOWED_DATE) {
          startDateError.textContent = 'Menor data disponível 30/12/2024';
          startDateError.style.display = 'block';
          this.style.borderColor = '#ff0000';
        } else {
          startDateError.style.display = 'none';
          this.style.borderColor = '#ccc';
          if (new Date(endDateInput.value) < selected) {
            endDateInput.value = this.value;
          }
        }
      });

      endDateInput.addEventListener('change', function() {
        const selected = new Date(this.value);
        if (selected < MIN_ALLOWED_DATE) {
          endDateError.textContent = 'Menor data disponível 30/12/2024';
          endDateError.style.display = 'block';
          this.style.borderColor = '#ff0000';
        } else {
          endDateError.style.display = 'none';
          this.style.borderColor = '#ccc';
          if (new Date(startDateInput.value) > selected) {
            startDateInput.value = this.value;
          }
        }
      });
    }

    // Botões de período
    function setupPeriodButtons() {
      periodBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          periodBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const periodo = this.getAttribute('data-period');
          carregarDados({ periodo });
        });
      });
    }

    // Botão de intervalo customizado
    function setupCustomRangeButton() {
      applyBtn.addEventListener('click', function() {
        const start = new Date(startDateInput.value);
        const end = new Date(endDateInput.value);

        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
          alert('Por favor, selecione datas válidas.');
          return;
        }

        if (start < MIN_ALLOWED_DATE || end < MIN_ALLOWED_DATE) {
          alert('Menor data disponível 30/12/2024');
          return;
        }

        if (start > end) {
          alert('A data de início deve ser anterior à data de fim.');
          return;
        }

        periodBtns.forEach(b => b.classList.remove('active'));
        carregarDados({ dataInicio: startDateInput.value, dataFim: endDateInput.value });
      });
    }

    // Inicialização
    function init() {
      setupDateInputs();
      setupDateValidation();
      setupPeriodButtons();
      setupCustomRangeButton();
      carregarDados({ periodo: '1m' }); // carrega padrão
      window.addEventListener('resize', () => {
        if (ibovespaChart) ibovespaChart.resize();
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
