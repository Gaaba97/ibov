<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Simon</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #fff;
      font-family: "DM Sans", sans-serif;
      color: #000;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
    }

    .header-info {
      width: 95%;
      max-width: 1200px;
      text-align: center;
      margin-bottom: 25px;
      flex-shrink: 0;
    }

    .header-info h1 {
      font-size: 24px;
      color: #1E4DB7;
      margin: 0 0 5px 0;
    }

    .subtitle {
      font-size: 14px;
      color: #555;
      margin: 0;
    }

    .chart-main-container {
      width: 95%;
      max-width: 1200px;
      height: auto;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      margin-bottom: 30px;
    }

    .chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 400px;
      background-color: #fff;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
    }

    canvas {
      width: 100%;
      height: 100% !important;
    }

    .period-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      width: 100%;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .period-btn {
      padding: 8px 16px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .period-btn:hover {
      background-color: #e0e0e0;
    }

    .period-btn.active {
      background-color: #164CAD;
      color: white;
      border-color: #164CAD;
    }

    .custom-range-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 20px;
      padding: 8px 12px;
      background-color: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .custom-range-container label {
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
    }

    .date-input {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      width: 120px;
    }

    .apply-btn {
      padding: 6px 12px;
      background-color: #164CAD;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Montserrat", sans-serif;
      font-size: 14px;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }

    .apply-btn:hover {
      background-color: #0d3a8a;
    }

    .date-error {
      position: absolute;
      top: 100%;
      left: 0;
      color: #ff0000;
      font-size: 11px;
      font-family: "Montserrat", sans-serif;
      margin-top: 2px;
      display: none;
      background: white;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #ff0000;
      z-index: 10;
      white-space: nowrap;
    }

    .date-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .loading {
      color: #666;
      font-style: italic;
      font-size: 16px;
      text-align: center;
      margin-top: 20px;
    }

    .error {
      color: #ff0000;
      background-color: #ffe6e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }

    /* ESTILOS DO TOOLTIP PERSONALIZADO */
    .custom-tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #164CAD;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      pointer-events: none;
      z-index: 100;
      font-family: "Montserrat", sans-serif;
      backdrop-filter: blur(5px);
      transition: opacity 0.2s ease;
      opacity: 0;
    }

    .custom-tooltip.visible {
      opacity: 1;
    }

    .custom-tooltip::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .custom-tooltip.top::before {
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px 8px 0 8px;
      border-color: #164CAD transparent transparent transparent;
    }

    .custom-tooltip.bottom::before {
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 8px 8px 8px;
      border-color: transparent transparent #164CAD transparent;
    }

    .custom-tooltip.left::before {
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 0 8px 8px;
      border-color: transparent transparent transparent #164CAD;
    }

    .custom-tooltip.right::before {
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 8px 8px 0;
      border-color: transparent #164CAD transparent transparent;
    }

    .tooltip-header {
      font-weight: 550;
      color: #000;
      margin-bottom: 8px;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
    }

    .tooltip-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .tooltip-item:last-child {
      margin-bottom: 0;
    }

    .tooltip-label {
      display: flex;
      align-items: center;
      color: #000;
    }

    .tooltip-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }

    .tooltip-value {
      font-weight: 400;
      color: #000;
      margin-left: 12px;
    }

    /* CONTAINER PARA AS TRÊS TABELAS */
    .tables-wrapper {
      width: 95%;
      max-width: 1400px; /* Aumentado para acomodar mais colunas */
      display: flex;
      gap: 20px;
      margin-top: 40px;
      margin-bottom: 40px;
      justify-content: space-between;
      flex-wrap: nowrap; /* Garantir que não quebre linha */
    }

    /* ESTILOS DA TABELA */
    .table-container {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
      overflow-x: auto; /* Adicionar scroll horizontal se necessário */
    }

    .contributions-table {
      width: 100%;
      border-collapse: collapse;
      font-family: "Montserrat", sans-serif;
      font-size: 13px; /* Reduzido para caber melhor */
      min-width: 400px; /* Largura mínima para tabelas */
    }

    .contributions-table th {
      background-color: #164CAD;
      color: white;
      font-weight: 500;
      text-align: center;
      padding: 10px 8px; /* Reduzido para caber mais colunas */
      white-space: nowrap;
    }

    .contributions-table td {
      padding: 8px 8px; /* Reduzido para caber mais colunas */
      border-bottom: 1px solid #e0e0e0;
      text-align: center;
    }

    .contributions-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .contributions-table tbody tr:hover {
      background-color: #f0f5ff;
    }

    .contributions-table .group-cell {
      font-weight: 500;
      color: #164CAD;
      text-align: left;
    }

    .contributions-table .value-cell {
      text-align: center;
      font-weight: 500;
      font-family: "DM Sans", sans-serif;
    }

    .table-title {
      width: 100%;
      text-align: center;
      margin-top: 40px;
      margin-bottom: 15px;
      font-family: "Montserrat", sans-serif;
      font-size: 16px; /* Reduzido para melhor proporção */
      color: #1E4DB7;
      font-weight: 500;
      display: none;
    }

    /* Container para título + tabela */
    .table-section {
      width: 32%; /* Cada tabela ocupa aproximadamente 1/3 do espaço */
      display: flex;
      flex-direction: column;
      min-width: 400px; /* Largura mínima para cada seção */
    }

    /* Responsividade para telas menores */
    @media (max-width: 1300px) {
      .tables-wrapper {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .table-section {
        width: 48%;
        min-width: 350px;
        margin-bottom: 20px;
      }
    }
    
    @media (max-width: 900px) {
      .table-section {
        width: 100%;
        min-width: 300px;
      }
      
      .period-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .custom-range-container {
        margin-left: 0;
        margin-top: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-info">
      <h1>Ibovespa - Atribuição de Performance</h1>
      <div class="subtitle" id="subtitle">Carregando dados da planilha...</div>
    </div>
    
    <div class="chart-main-container">
      <div class="chart-container">
        <canvas id="ibovespaChart"></canvas>
      </div>
      <div class="period-controls" id="periodControls" style="display: none;">
        <button class="period-btn active" data-period="1m">1 Mês</button>
        <button class="period-btn" data-period="3m">3 Meses</button>
        <button class="period-btn" data-period="6m">6 Meses</button>
        <button class="period-btn" data-period="1y">1 Ano</button>
        <button class="period-btn" data-period="all">Todo Período</button>
        
        <div class="custom-range-container">
          <label for="startDate">De:</label>
          <div class="date-input-wrapper">
            <input type="date" id="startDate" class="date-input">
            <div id="startDateError" class="date-error"></div>
          </div>
          
          <label for="endDate">Até:</label>
          <div class="date-input-wrapper">
            <input type="date" id="endDate" class="date-input">
            <div id="endDateError" class="date-error"></div>
          </div>
          
          <button id="applyCustomRange" class="apply-btn">Aplicar</button>
        </div>
      </div>
      <div class="loading" id="loadingIndicator">Carregando gráfico...</div>
    </div>

    <!-- WRAPPER PARA AS TRÊS TABELAS -->
    <div class="tables-wrapper" id="tablesWrapper">
      <!-- Tabela 1 -->
      <div class="table-section">
        <div class="table-title" id="tableTitle1">
          Maiores empresas (1)
        </div>
        <div class="table-container" id="tableContainer1">
          <table class="contributions-table">
            <thead>
              <tr>
                <th>Grupo de Empresas</th>
                <th>Variação (%)</th>
                <th>Contribuição (%)</th>
                <th>Peso Atual (%)</th>
              </tr>
            </thead>
            <tbody id="contributionsTableBody1">
              <!-- As linhas serão preenchidas via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabela 2 -->
      <div class="table-section">
        <div class="table-title" id="tableTitle2">
          Maiores empresas (2)
        </div>
        <div class="table-container" id="tableContainer2">
          <table class="contributions-table">
            <thead>
              <tr>
                <th>Grupo de Empresas</th>
                <th>Variação (%)</th>
                <th>Contribuição (%)</th>
                <th>Peso Atual (%)</th>
              </tr>
            </thead>
            <tbody id="contributionsTableBody2">
              <!-- As linhas serão preenchidas via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabela 3 -->
      <div class="table-section">
        <div class="table-title" id="tableTitle3">
          Maiores empresas (3)
        </div>
        <div class="table-container" id="tableContainer3">
          <table class="contributions-table">
            <thead>
              <tr>
                <th>Grupo de Empresas</th>
                <th>Variação (%)</th>
                <th>Contribuição (%)</th>
                <th>Peso Atual (%)</th>
              </tr>
            </thead>
            <tbody id="contributionsTableBody3">
              <!-- As linhas serão preenchidas via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script>
    // URL da planilha pública do Google Sheets (Ibovespa)
    const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjEpwKbe5Q2Em0ZexDiCjBT1qUjr2SM2xCuROpQKnHr64XxUqaZ4p2eQurmL_4JTt45Wr-Ok5GRTdn/pub?output=csv";
    
    // URL da planilha de Pesos (aba Pesos)
    const WEIGHTS_SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjEpwKbe5Q2Em0ZexDiCjBT1qUjr2SM2xCuROpQKnHr64XxUqaZ4p2eQurmL_4JTt45Wr-Ok5GRTdn/pub?gid=1&output=csv";
    
    // Variáveis globais
    let ibovespaChart = null;
    let allIbovespaData = [];
    let filteredData = [];
    let percentData = []; // Dados em percentual
    let weightsData = []; // Array para armazenar os pesos das empresas
    
    // Data mínima permitida (30/12/2024)
    const MIN_ALLOWED_DATE = new Date(2024, 11, 29); // Mês é 0-indexed (11 = Dezembro)
    
    // Tooltip personalizado
    let customTooltip = null;

    function createCustomTooltip() {
      if (customTooltip) return customTooltip;
      
      customTooltip = document.createElement('div');
      customTooltip.className = 'custom-tooltip';
      document.querySelector('.chart-main-container').appendChild(customTooltip);
      return customTooltip;
    }

    function showCustomTooltip(chart, tooltip) {
      // Criar ou obter o tooltip personalizado
      const tooltipEl = createCustomTooltip();
      
      // Esconder tooltip se não há dados
      if (tooltip.opacity === 0) {
        tooltipEl.classList.remove('visible');
        return;
      }

      // Configurar conteúdo do tooltip
      if (tooltip.body) {
        const title = tooltip.title[0] || '';
        
        let tooltipHTML = `<div class="tooltip-header">${title}</div>`;
        
        // Adicionar dados de cada dataset
        tooltip.dataPoints.forEach((dataPoint, index) => {
          const dataset = chart.data.datasets[dataPoint.datasetIndex];
          
          // Encontrar o valor original correspondente
          const pointIndex = dataPoint.dataIndex;
          const originalValue = filteredData[pointIndex]?.value || 0;
          const percentValue = dataPoint.raw.y;
          
          const label = dataset.label || 'Ibovespa';
          const color = dataset.borderColor || '#164CAD';
          
          tooltipHTML += `
            <div class="tooltip-item">
              <span class="tooltip-label">
                <span class="tooltip-color" style="background-color: ${color}"></span>
                ${label}
              </span>
            </div>
            <div class="tooltip-item">
              <span class="tooltip-label">Variação:</span>
              <span class="tooltip-value" style="color: ${percentValue >= 0 ? '#008000' : '#ff0000'};">
                ${percentValue >= 0 ? '+' : ''}${percentValue.toFixed(2)}%
              </span>
            </div>
            <div class="tooltip-item">
              <span class="tooltip-label">Valor:</span>
              <span class="tooltip-value">${originalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} pontos</span>
            </div>
          `;
        });
        
        tooltipEl.innerHTML = tooltipHTML;
      }

      // Posicionar o tooltip
      const position = chart.canvas.getBoundingClientRect();
      const chartContainer = document.querySelector('.chart-main-container');
      const containerRect = chartContainer.getBoundingClientRect();
      
      // Posição relativa ao container do gráfico
      let left = position.left + tooltip.caretX - containerRect.left;
      let top = position.top + tooltip.caretY - containerRect.top;
      
      // Ajustar posição para não sair da tela
      const tooltipWidth = tooltipEl.offsetWidth;
      const tooltipHeight = tooltipEl.offsetHeight;
      
      // Definir posição padrão (acima do ponto)
      let placement = 'top';
      
      // Verificar se precisa ajustar a posição
      if (top - tooltipHeight - 10 < 0) {
        placement = 'bottom';
        top += 20;
      } else {
        top -= tooltipHeight + 10;
      }
      
      // Ajustar horizontalmente para não sair da tela
      if (left + tooltipWidth > containerRect.width) {
        left = containerRect.width - tooltipWidth - 10;
      } else if (left < 0) {
        left = 10;
      } else {
        left -= tooltipWidth / 2;
      }
      
      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      
      // Atualizar classe de posicionamento
      tooltipEl.className = `custom-tooltip ${placement} visible`;
    }

    // Função para buscar dados da planilha
    async function loadIbovespaData() {
      try {
        console.log('Iniciando busca de dados do Ibovespa...');
        document.getElementById('subtitle').textContent = 'Carregando dados da planilha...';
        
        const response = await fetch(SPREADSHEET_URL);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('Dados CSV recebidos, processando...');
        
        // Processar os dados CSV
        processCSVData(csvText);
        
      } catch (error) {
        console.error('Erro ao buscar dados:', error);
        document.getElementById('subtitle').textContent = 'Erro ao carregar dados da planilha';
        document.getElementById('loadingIndicator').textContent = `Erro: ${error.message}`;
        document.getElementById('loadingIndicator').className = "error";
        
        // Carregar dados de exemplo em caso de falha
        loadSampleData();
      }
    }

    // Função para buscar dados dos pesos da planilha
    async function loadWeightsData() {
      try {
        console.log('Iniciando busca de dados dos pesos...');
        
        const response = await fetch(WEIGHTS_SPREADSHEET_URL);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('Dados de pesos CSV recebidos, processando...');
        
        // Processar os dados CSV de pesos
        processWeightsCSVData(csvText);
        
      } catch (error) {
        console.error('Erro ao buscar dados dos pesos:', error);
        // Em caso de erro, usar pesos de exemplo
        loadSampleWeightsData();
      }
    }

    // Função para processar dados CSV de pesos
    function processWeightsCSVData(csvText) {
      try {
        // Dividir o CSV em linhas
        const lines = csvText.split('\n');
        
        // CORREÇÃO: Buscar a partir da linha que contém "5 Maiores Empresas"
        let startIndex = -1;
        let foundHeader = false;
        
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes('5 Maiores Empresas')) {
            // Encontrou o cabeçalho, os dados começam na próxima linha
            foundHeader = true;
            continue;
          }
          
          // Se encontrou o cabeçalho, a próxima linha contém os pesos (linha 1 após o cabeçalho)
          if (foundHeader) {
            startIndex = i;
            break;
          }
        }
        
        // Se não encontrou pelo título, procura por linhas que contenham pesos
        if (startIndex === -1) {
          for (let i = 0; i < lines.length; i++) {
            // Procura por linhas com números (pesos)
            if (lines[i].match(/\d+[.,]\d+/)) {
              startIndex = i;
              break;
            }
          }
        }
        
        // Se ainda não encontrou, usa a partir da primeira linha
        if (startIndex === -1) {
          startIndex = 0;
        }
        
        console.log(`Iniciando processamento de pesos a partir da linha ${startIndex + 1}`);
        
        // Extrair os pesos da coluna C (índice 2 se considerarmos 0-based)
        // Agora precisamos pegar apenas uma linha (que contém os 30 pesos)
        weightsData = [];
        
        if (startIndex < lines.length) {
          const line = lines[startIndex].trim();
          
          if (line && line.length > 0) {
            // Dividir a linha por vírgulas
            let columns;
            
            if (line.includes('"')) {
              columns = parseCSVLine(line);
            } else {
              columns = line.split(',');
            }
            
            // CORREÇÃO: Vamos percorrer todas as colunas a partir da coluna C (índice 2)
            // para pegar os 30 pesos
            for (let col = 2; col < columns.length && weightsData.length < 30; col++) {
              const weightStr = columns[col]?.trim().replace(/"/g, '') || '0';
              
              // Remover pontos de milhar e converter vírgula para ponto
              const cleanedWeight = weightStr.replace(/\./g, '').replace(',', '.');
              const weight = parseFloat(cleanedWeight);
              
              if (!isNaN(weight) && weight > 0) {
                weightsData.push(weight);
              } else {
                // Se não conseguir converter, adiciona 0
                weightsData.push(0);
              }
            }
          }
        }
        
        // Se não conseguiu pegar 30 pesos, complete com zeros
        while (weightsData.length < 30) {
          weightsData.push(0);
        }
        
        console.log(`Processados ${weightsData.length} pesos.`);
        console.log(`Pesos das 5 primeiras empresas:`, weightsData.slice(0, 5));
        console.log(`Soma das 5 primeiras:`, weightsData.slice(0, 5).reduce((a, b) => a + b, 0));
        
        if (weightsData.length === 0) {
          console.warn('Nenhum peso válido encontrado, usando pesos de exemplo');
          loadSampleWeightsData();
        }
        
      } catch (error) {
        console.error('Erro ao processar dados de pesos CSV:', error);
        loadSampleWeightsData();
      }
    }

    // Função para carregar pesos de exemplo
    function loadSampleWeightsData() {
      console.log('Carregando pesos de exemplo...');
      
      // Pesos de exemplo baseados em distribuição típica do Ibovespa
      // Atualizado para dar 34.90% para as 5 maiores
      weightsData = [
        8.5, 7.2, 6.8, 5.5, 6.9,  // 5 maiores (soma = 34.9%)
        4.3, 4.1, 3.8, 3.5, 3.2,  // 6-10
        3.0, 2.8, 2.6, 2.4, 2.2,  // 11-15
        2.0, 1.8, 1.6, 1.5, 1.4,  // 16-20
        1.3, 1.2, 1.1, 1.0, 0.9,  // 21-25
        0.8, 0.7, 0.6, 0.5, 0.4   // 26-30
      ];
      
      console.log('Pesos de exemplo carregados:', weightsData);
      console.log('Soma das 5 primeiras (exemplo):', weightsData.slice(0, 5).reduce((a, b) => a + b, 0));
    }

    // Função para processar dados CSV
    function processCSVData(csvText) {
      try {
        // Dividir o CSV em linhas
        const lines = csvText.split('\n');
        
        // Processar as linhas de dados
        allIbovespaData = [];
        
        // Procurar pela seção "A. Pontos" - coluna A (Data) e coluna B (Ibovespa)
        let startIndex = -1;
        
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes('A. Pontos') || (lines[i].includes('Data') && lines[i].includes('Ibovespa'))) {
            startIndex = i;
            break;
          }
        }
        
        // Se não encontrou pelo título, procura por linhas que contenham datas e números
        if (startIndex === -1) {
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].match(/\d{1,2}\/\d{1,2}\/\d{4}/) && lines[i].match(/\d+\.?\d*/)) {
              startIndex = i;
              break;
            }
          }
        }
        
        // Se ainda não encontrou, usa a partir da segunda linha (supondo que a primeira é cabeçalho)
        if (startIndex === -1) {
          startIndex = 1;
        }
        
        console.log(`Iniciando processamento a partir da linha ${startIndex + 1}`);
        
        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          
          // Ignorar linhas vazias ou que não contenham dados relevantes
          if (!line || line.length === 0 || line.startsWith('"') || line.includes('A. Pontos')) {
            continue;
          }
          
          // Dividir a linha por vírgulas
          let columns;
          
          // Tentar dividir por vírgula simples
          if (line.includes('"')) {
            // Processamento mais complexo para células com aspas
            columns = parseCSVLine(line);
          } else {
            columns = line.split(',');
          }
          
          // Verificar se temos pelo menos duas colunas (Data e Ibovespa)
          if (columns.length >= 2) {
            const dateStr = columns[0].trim().replace(/"/g, '');
            const valueStr = columns[1].trim().replace(/"/g, '');
            
            // Validar e converter a data
            let date;
            try {
              // Tentar diferentes formatos de data
              if (dateStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
                // Formato DD/MM/YYYY
                const parts = dateStr.split('/');
                date = new Date(parts[2], parts[1] - 1, parts[0]);
              } else if (dateStr.match(/\d{4}-\d{1,2}-\d{1,2}/)) {
                // Formato YYYY-MM-DD
                date = new Date(dateStr);
              } else {
                // Tentar parse direto
                date = new Date(dateStr);
              }
              
              // Validar a data
              if (isNaN(date.getTime())) {
                console.warn(`Data inválida na linha ${i + 1}: ${dateStr}`);
                continue;
              }
            } catch (e) {
              console.warn(`Erro ao processar data na linha ${i + 1}: ${dateStr}`, e);
              continue;
            }
            
            // Validar e converter o valor do Ibovespa
            // Remover pontos de milhar e converter vírgula para ponto
            const cleanedValue = valueStr.replace(/\./g, '').replace(',', '.');
            const value = parseFloat(cleanedValue);
            
            if (isNaN(value) || value <= 0) {
              console.warn(`Valor inválido na linha ${i + 1}: ${valueStr}`);
              continue;
            }
            
            // Extrair dados das empresas (colunas D até AG)
            const empresas = [];
            // Coluna D é o índice 3 (0-based), coluna AG é o índice 32
            // São 30 colunas no total (D até AG)
            for (let col = 3; col <= 32 && col < columns.length; col++) {
              const empresaValueStr = columns[col]?.trim().replace(/"/g, '') || '0';
              const empresaValue = parseFloat(empresaValueStr.replace(/\./g, '').replace(',', '.'));
              empresas.push(isNaN(empresaValue) ? 0 : empresaValue);
            }
            
            // Adicionar aos dados
            allIbovespaData.push({
              date: date,
              dateStr: dateStr,
              value: value,
              formattedValue: value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
              empresas: empresas
            });
          }
        }
        
        console.log(`Processados ${allIbovespaData.length} registros válidos.`);
        console.log(`Exemplo de dados das empresas (primeiro registro):`, allIbovespaData[0]?.empresas?.length || 0, 'colunas');
        
        if (allIbovespaData.length === 0) {
          throw new Error('Nenhum dado válido encontrado na planilha.');
        }
        
        // Ordenar por data (do mais antigo para o mais recente)
        allIbovespaData.sort((a, b) => a.date - b.date);
        
        // Atualizar subtítulo com a última data
        const lastRecord = allIbovespaData[allIbovespaData.length - 1];
        document.getElementById('subtitle').textContent = `Última atualização: ${lastRecord.dateStr} - Ibovespa: ${lastRecord.formattedValue} pontos`;
        
        // Carregar dados dos pesos
        loadWeightsData().then(() => {
          // Configurar as datas mínima e máxima para os campos de entrada
          setupDateInputs();
          
          // Mostrar controles de período e esconder indicador de carregamento
          document.getElementById('periodControls').style.display = 'flex';
          document.getElementById('loadingIndicator').style.display = 'none';
          
          // Criar gráfico principal
          createMainChart();
          
          // Inicializar com filtro de 1 mês
          filterDataByMonths(1);
          
          // Configurar eventos dos botões
          setupPeriodButtons();
          
          // Configurar evento para o botão de intervalo personalizado
          setupCustomRangeButton();
          
          // Configurar eventos de validação em tempo real para os campos de data
          setupDateValidation();
        });
        
      } catch (error) {
        console.error('Erro ao processar dados CSV:', error);
        document.getElementById('subtitle').textContent = 'Erro ao processar dados da planilha';
        document.getElementById('loadingIndicator').textContent = `Erro: ${error.message}`;
        document.getElementById('loadingIndicator').className = "error";
        
        // Carregar dados de exemplo em caso de falha
        loadSampleData();
      }
    }
    
    // Configurar as datas mínima e máxima para os campos de entrada
    function setupDateInputs() {
      if (allIbovespaData.length === 0) return;
      
      // Encontrar a data mais antiga e mais recente
      const minDate = allIbovespaData[0].date;
      const maxDate = allIbovespaData[allIbovespaData.length - 1].date;
      
      // Formatar datas no formato YYYY-MM-DD para os inputs
      const formatDateForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      // Definir os valores padrão (últimos 30 dias)
      const defaultEndDate = maxDate;
      const defaultStartDate = new Date(defaultEndDate);
      defaultStartDate.setMonth(defaultStartDate.getMonth() - 1);
      
      // Configurar os atributos dos inputs
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      
      startDateInput.min = formatDateForInput(minDate);
      startDateInput.max = formatDateForInput(maxDate);
      startDateInput.value = formatDateForInput(defaultStartDate);
      
      endDateInput.min = formatDateForInput(minDate);
      endDateInput.max = formatDateForInput(maxDate);
      endDateInput.value = formatDateForInput(defaultEndDate);
    }
    
    // Configurar validação em tempo real para os campos de data
    function setupDateValidation() {
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const startDateError = document.getElementById('startDateError');
      const endDateError = document.getElementById('endDateError');
      
      // Formatar data no formato dd/mm/aaaa
      const formatDateBR = (date) => {
        return date.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      };
      
      // Validar data inicial
      startDateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const minAllowedDate = MIN_ALLOWED_DATE;
        
        // CORREÇÃO: Agora só mostra erro se for MENOR (não menor ou igual) a 30/12/2024
        if (selectedDate < minAllowedDate) {
          startDateError.textContent = `Menor data disponível 30/12/2024`;
          startDateError.style.display = 'block';
          this.style.borderColor = '#ff0000';
        } else {
          startDateError.style.display = 'none';
          this.style.borderColor = '#ccc';
          
          // Verificar se a data final é anterior à data inicial
          const endDate = new Date(endDateInput.value);
          if (endDate < selectedDate) {
            endDateInput.value = this.value;
          }
        }
      });
      
      // Validar data final
      endDateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const minAllowedDate = MIN_ALLOWED_DATE;
        
        // CORREÇÃO: Agora só mostra erro se for MENOR (não menor ou igual) a 30/12/2024
        if (selectedDate < minAllowedDate) {
          endDateError.textContent = `Menor data disponível 30/12/2024`;
          endDateError.style.display = 'block';
          this.style.borderColor = '#ff0000';
        } else {
          endDateError.style.display = 'none';
          this.style.borderColor = '#ccc';
          
          // Verificar se a data inicial é posterior à data final
          const startDate = new Date(startDateInput.value);
          if (startDate > selectedDate) {
            startDateInput.value = this.value;
            // Também validar a nova data inicial
            if (startDate < minAllowedDate) {
              startDateError.textContent = `Menor data disponível ${formatDateBR(minAllowedDate)}`;
              startDateError.style.display = 'block';
              startDateInput.style.borderColor = '#ff0000';
            }
          }
        }
      });
      
      // Também validar quando os inputs perdem o foco
      startDateInput.addEventListener('blur', function() {
        if (this.value) {
          const event = new Event('change');
          this.dispatchEvent(event);
        }
      });
      
      endDateInput.addEventListener('blur', function() {
        if (this.value) {
          const event = new Event('change');
          this.dispatchEvent(event);
        }
      });
    }
    
    // Função auxiliar para processar linha CSV com aspas
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }
    
    // Função para converter dados originais em percentual
    function convertToPercentageData(originalData) {
      if (!originalData || originalData.length === 0) return [];
      
      const firstValue = originalData[0].value;
      const percentageData = [];
      
      for (let i = 0; i < originalData.length; i++) {
        const item = originalData[i];
        const percentage = ((item.value / firstValue) - 1) * 100;
        
        percentageData.push({
          x: item.date,
          y: percentage
        });
      }
      
      return percentageData;
    }
    
    // Função para calcular os pesos dos grupos
    function calculateGroupWeights() {
      if (weightsData.length === 0) {
        // Se não houver pesos, retornar pesos vazios
        return {
          peso5Maiores: 0,
          peso10Maiores: 0,
          peso15Maiores: 0,
          peso20Maiores: 0,
          peso25Maiores: 0,
          peso30Maiores: 0,
          pesoRestante: 0,
          pesoIbov: 100
        };
      }
      
      // Calcular somas acumuladas
      let soma5Maiores = 0;
      let soma10Maiores = 0;
      let soma15Maiores = 0;
      let soma20Maiores = 0;
      let soma25Maiores = 0;
      let soma30Maiores = 0;
      
      for (let i = 0; i < weightsData.length; i++) {
        const peso = weightsData[i];
        if (i < 5) soma5Maiores += peso;
        if (i < 10) soma10Maiores += peso;
        if (i < 15) soma15Maiores += peso;
        if (i < 20) soma20Maiores += peso;
        if (i < 25) soma25Maiores += peso;
        if (i < 30) soma30Maiores += peso;
      }
      
      // Calcular o resto
      const pesoRestante = 100 - soma30Maiores;
      
      console.log("Cálculo dos pesos:", {
        soma5Maiores,
        soma10Maiores,
        soma15Maiores,
        soma20Maiores,
        soma25Maiores,
        soma30Maiores,
        pesoRestante
      });
      
      return {
        peso5Maiores: soma5Maiores,
        peso10Maiores: soma10Maiores,
        peso15Maiores: soma15Maiores,
        peso20Maiores: soma20Maiores,
        peso25Maiores: soma25Maiores,
        peso30Maiores: soma30Maiores,
        pesoRestante: pesoRestante,
        pesoIbov: 100
      };
    }
    
    // Criar gráfico principal do Ibovespa
    function createMainChart() {
      if (allIbovespaData.length === 0) return;
      
      const canvas = document.getElementById('ibovespaChart');
      const ctx = canvas.getContext('2d');
      
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      const createGradient = (ctx, chartArea) => {
        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
        gradient.addColorStop(0, "#F6F8FC");
        gradient.addColorStop(0.5, "#8EA8D7");
        gradient.addColorStop(1, "#164CAD");
        return gradient;
      };
      
      // Preparar dados iniciais (todos os dados)
      const initialData = convertToPercentageData(allIbovespaData);
      
      ibovespaChart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              label: "Ibovespa",
              data: initialData,
              borderColor: "#164CAD",
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.15,
              fill: true,
              backgroundColor: function(context) {
                const chart = context.chart;
                const {ctx, chartArea} = chart;
                if (!chartArea) {
                  return null;
                }
                return createGradient(ctx, chartArea);
              },
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index',
          },
          plugins: {
            legend: {
              position: "top",
              labels: {
                usePointStyle: true,
                pointStyle: "circle",
                color: "#000000",
                font: {
                  family: "Montserrat",
                  size: 14,
                  weight: "300",
                },
              },
            },
            tooltip: {
              enabled: false, // Desabilitar tooltip padrão
              external: (context) => {
                // Tooltip externo personalizado
                showCustomTooltip(context.chart, context.tooltip);
              }
            },
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "month",
                displayFormats: { 
                  month: "MMM - yy" 
                },
                tooltipFormat: "dd/MM/yyyy"
              },
              ticks: {
                color: "#000000",
                maxRotation: 45,
                minRotation: 45,
                font: {
                  family: "Montserrat",
                  size: 12,
                  weight: "300",
                },
                // Mapear meses para português
                callback: function(value, index, values) {
                  const date = new Date(value);
                  const month = date.getMonth();
                  const year = date.getFullYear().toString().slice(-2);
                  
                  const mesesPortugues = [
                    'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
                  ];
                  
                  return `${mesesPortugues[month]} - ${year}`;
                }
              },
              grid: { color: "rgba(0,0,0,0.05)" },
            },
            y: {
              ticks: {
                color: "#000000",
                font: {
                  family: "Montserrat",
                  size: 12,
                  weight: "300",
                },
                callback: (v) => `${v.toFixed(1)}%`, // Formatando como porcentagem
              },
              grid: { color: "rgba(0,0,0,0.05)" },
              title: {
                display: true,
                text: 'Variação Percentual (%)',
                color: "#000000",
                font: {
                  family: "Montserrat",
                  size: 12,
                  weight: "300",
                }
              }
            },
          },
        },
      });
      
      console.log("Gráfico principal do Ibovespa criado com sucesso");
    }
    
    // Filtrar dados por número de meses
    function filterDataByMonths(months) {
      if (allIbovespaData.length === 0) return;
      
      const cutoffDate = new Date();
      cutoffDate.setMonth(cutoffDate.getMonth() - months);
      
      filteredData = allIbovespaData.filter(record => record.date >= cutoffDate);
      
      // Se não houver dados no período filtrado, usar todos os dados
      if (filteredData.length === 0) {
        filteredData = [...allIbovespaData];
      }
      
      // Atualizar gráfico
      updateMainChartData();
      
      // Atualizar tabela
      updateContributionsTable();
    }
    
    // Filtrar dados por intervalo de datas personalizado
    function filterDataByCustomRange(startDate, endDate) {
      if (allIbovespaData.length === 0) return false;
      
      // CORREÇÃO: Adicionar 1 dia à data final para incluir o dia todo
      const endDateAdjusted = new Date(endDate);
      endDateAdjusted.setDate(endDateAdjusted.getDate() + 1);
      
      filteredData = allIbovespaData.filter(record => {
        return record.date >= startDate && record.date < endDateAdjusted;
      });
      
      // Se não houver dados no intervalo, mostrar mensagem
      if (filteredData.length === 0) {
        alert('Nenhum dado encontrado para o intervalo selecionado.');
        return false;
      }
      
      // Atualizar gráfico
      updateMainChartData();
      
      // Atualizar tabela
      updateContributionsTable();
      
      return true;
    }
    
    // Atualizar dados do gráfico principal
    function updateMainChartData() {
      if (!ibovespaChart || filteredData.length === 0) return;
      
      // Converter dados filtrados para percentual
      const percentageData = convertToPercentageData(filteredData);
      
      // Atualizar dados do gráfico
      ibovespaChart.data.datasets[0].data = percentageData;
      
      // Atualizar o gráfico
      ibovespaChart.update();
    }
    
    // Função para calcular e atualizar a tabela de contribuições
    function updateContributionsTable() {
      if (filteredData.length < 2) {
        // Esconder todas as tabelas
        document.getElementById('tableContainer1').style.display = 'none';
        document.getElementById('tableContainer2').style.display = 'none';
        document.getElementById('tableContainer3').style.display = 'none';
        document.getElementById('tableTitle1').style.display = 'none';
        document.getElementById('tableTitle2').style.display = 'none';
        document.getElementById('tableTitle3').style.display = 'none';
        return;
      }
      
      // Calcular a variação do Ibovespa no período (usando data inicial e data final)
      const valorInicialIbovespa = filteredData[0].value; // Primeiro dia
      const valorFinalIbovespa = filteredData[filteredData.length - 1].value; // Último dia
      const variacaoIbovespa = valorFinalIbovespa - valorInicialIbovespa;
      const variacaoPercentualIbovespa = (variacaoIbovespa / valorInicialIbovespa) * 100;
      
      // Se não houver variação, não podemos calcular as contribuições
      if (variacaoIbovespa === 0) {
        document.getElementById('tableContainer1').style.display = 'none';
        document.getElementById('tableContainer2').style.display = 'none';
        document.getElementById('tableContainer3').style.display = 'none';
        document.getElementById('tableTitle1').style.display = 'none';
        document.getElementById('tableTitle2').style.display = 'none';
        document.getElementById('tableTitle3').style.display = 'none';
        return;
      }
      
      // Calcular os pesos dos grupos
      const pesos = calculateGroupWeights();
      
      // Definir os grupos de empresas e suas respectivas colunas
      const grupos = [
        { nome: "5 Maiores Empresas", colInicio: 0, colFim: 4, peso: pesos.peso5Maiores },   // D-H (colunas 0-4)
        { nome: "10 Maiores Empresas", colInicio: 0, colFim: 9, peso: pesos.peso10Maiores },  // D-M (colunas 0-9)
        { nome: "15 Maiores Empresas", colInicio: 0, colFim: 14, peso: pesos.peso15Maiores }, // D-R (colunas 0-14)
        { nome: "20 Maiores Empresas", colInicio: 0, colFim: 19, peso: pesos.peso20Maiores }, // D-W (colunas 0-19)
        { nome: "25 Maiores Empresas", colInicio: 0, colFim: 24, peso: pesos.peso25Maiores }, // D-AB (colunas 0-24)
        { nome: "30 Maiores Empresas", colInicio: 0, colFim: 29, peso: pesos.peso30Maiores }  // D-AG (colunas 0-29)
      ];
      
      // Atualizar todas as três tabelas com os mesmos dados
      for (let tableNum = 1; tableNum <= 3; tableNum++) {
        const tableBody = document.getElementById(`contributionsTableBody${tableNum}`);
        tableBody.innerHTML = '';
        
        let contribuicao30Maiores = 0;
        let variacao30Maiores = 0;
        
        // Calcular contribuição para cada grupo
        grupos.forEach(grupo => {
          let somaEmpresas = 0;
          
          // Somar os valores das empresas a partir do dia seguinte ao início
          for (let i = 1; i < filteredData.length; i++) {
            const registro = filteredData[i];
            if (registro.empresas && registro.empresas.length > 0) {
              for (let j = grupo.colInicio; j <= grupo.colFim && j < registro.empresas.length; j++) {
                somaEmpresas += registro.empresas[j] || 0;
              }
            }
          }
          
          // Calcular a contribuição percentual (sobre a variação do Ibovespa)
          const contribuicaoPercentual = (somaEmpresas / variacaoIbovespa) * 100;
          
          // Calcular a variação percentual (sobre o valor inicial do Ibovespa)
          const variacaoPercentual = (somaEmpresas / valorInicialIbovespa) * 100;
          
          // Salvar a contribuição das 30 maiores para calcular o restante
          if (grupo.nome === "30 Maiores Empresas") {
            contribuicao30Maiores = contribuicaoPercentual;
            variacao30Maiores = variacaoPercentual;
          }
          
          // Formatar os valores com 2 casas decimais
          const variacaoFormatada = variacaoPercentual.toFixed(2);
          const contribuicaoFormatada = contribuicaoPercentual.toFixed(2);
          const pesoFormatado = grupo.peso.toFixed(2);
          const sinalVariacao = variacaoPercentual >= 0 ? '+' : '';
          const sinalContribuicao = contribuicaoPercentual >= 0 ? '+' : '';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="group-cell">${grupo.nome}</td>
            <td class="value-cell" style="color: ${variacaoPercentual >= 0 ? '#008000' : '#ff0000'}">
              ${sinalVariacao}${variacaoFormatada}%
            </td>
            <td class="value-cell" style="color: ${contribuicaoPercentual >= 0 ? '#008000' : '#ff0000'}">
              ${sinalContribuicao}${contribuicaoFormatada}%
            </td>
            <td class="value-cell" style="color: #1E4DB7">
              ${pesoFormatado}%
            </td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // Adicionar linha "Restante" (100% - contribuição das 30 maiores)
        const contribuicaoRestante = 100 - contribuicao30Maiores;
        const variacaoRestante = variacaoPercentualIbovespa - variacao30Maiores;
        const restanteFormatado = contribuicaoRestante.toFixed(2);
        const variacaoRestanteFormatada = variacaoRestante.toFixed(2);
        const sinalRestante = contribuicaoRestante >= 0 ? '+' : '';
        const sinalVariacaoRestante = variacaoRestante >= 0 ? '+' : '';
        
        const restanteRow = document.createElement('tr');
        restanteRow.innerHTML = `
          <td class="group-cell">Restante</td>
          <td class="value-cell" style="color: ${variacaoRestante >= 0 ? '#008000' : '#ff0000'}">
            ${sinalVariacaoRestante}${variacaoRestanteFormatada}%
          </td>
          <td class="value-cell" style="color: ${contribuicaoRestante >= 0 ? '#008000' : '#ff0000'}">
            ${sinalRestante}${restanteFormatado}%
          </td>
          <td class="value-cell" style="color: #1E4DB7">
            ${pesos.pesoRestante.toFixed(2)}%
          </td>
        `;
        
        tableBody.appendChild(restanteRow);
        
        // Adicionar linha "Ibovespa"
        const ibovespaVariacaoFormatada = variacaoPercentualIbovespa.toFixed(2);
        const sinalIbovespa = variacaoPercentualIbovespa >= 0 ? '+' : '';
        
        const ibovespaRow = document.createElement('tr');
        ibovespaRow.style.backgroundColor = '#f0f5ff';
        ibovespaRow.style.fontWeight = 'bold';
        ibovespaRow.innerHTML = `
          <td class="group-cell" style="color: #1E4DB7; font-weight: bold;">Ibovespa</td>
          <td class="value-cell" style="color: ${variacaoPercentualIbovespa >= 0 ? '#008000' : '#ff0000'}; font-weight: bold;">
            ${sinalIbovespa}${ibovespaVariacaoFormatada}%
          </td>
          <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
            100.00%
          </td>
          <td class="value-cell" style="color: #1E4DB7; font-weight: bold;">
            ${pesos.pesoIbov.toFixed(2)}%
          </td>
        `;
        
        tableBody.appendChild(ibovespaRow);
        
        // Mostrar a tabela e o título
        document.getElementById(`tableContainer${tableNum}`).style.display = 'block';
        document.getElementById(`tableTitle${tableNum}`).style.display = 'block';
      }
    }
    
    // Configurar eventos dos botões de período
    function setupPeriodButtons() {
      const buttons = document.querySelectorAll('.period-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', function() {
          // Remover classe 'active' de todos os botões
          buttons.forEach(b => b.classList.remove('active'));
          
          // Adicionar classe 'active' ao botão clicado
          this.classList.add('active');
          
          // Filtrar dados de acordo com o período selecionado
          const period = this.getAttribute('data-period');
          
          switch(period) {
            case '1m':
              filterDataByMonths(1);
              break;
            case '3m':
              filterDataByMonths(3);
              break;
            case '6m':
              filterDataByMonths(6);
              break;
            case '1y':
              filterDataByMonths(12);
              break;
            case 'all':
              filteredData = [...allIbovespaData];
              updateMainChartData();
              updateContributionsTable();
              break;
          }
        });
      });
    }
    
    // Configurar evento para o botão de intervalo personalizado
    function setupCustomRangeButton() {
      const applyBtn = document.getElementById('applyCustomRange');
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const startDateError = document.getElementById('startDateError');
      const endDateError = document.getElementById('endDateError');
      const periodButtons = document.querySelectorAll('.period-btn');
      
      applyBtn.addEventListener('click', function() {
        // Validar datas
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
          alert('Por favor, selecione datas válidas.');
          return;
        }
        
        // Verificar se a data é inferior a 30/12/2024
        const minAllowedDate = MIN_ALLOWED_DATE;
        let hasError = false;
        
        // CORREÇÃO: Agora só mostra erro se for MENOR (não menor ou igual) a 30/12/2024
        if (startDate < minAllowedDate) {
          startDateError.textContent = `Menor data disponível 30/12/2024`;
          startDateError.style.display = 'block';
          startDateInput.style.borderColor = '#ff0000';
          hasError = true;
        }
        
        // CORREÇÃO: Agora só mostra erro se for MENOR (não menor ou igual) a 30/12/2024
        if (endDate < minAllowedDate) {
          endDateError.textContent = `Menor data disponível 30/12/2024`;
          endDateError.style.display = 'block';
          endDateInput.style.borderColor = '#ff0000';
          hasError = true;
        }
        
        if (hasError) {
          return;
        }
        
        if (startDate > endDate) {
          alert('A data de início deve ser anterior à data de fim.');
          return;
        }
        
        // Remover classe 'active' de todos os botões de período
        periodButtons.forEach(btn => btn.classList.remove('active'));
        
        // Aplicar filtro personalizado
        if (filterDataByCustomRange(startDate, endDate)) {
          // Atualizar subtítulo com o intervalo selecionado
          const formatDateForDisplay = (date) => {
            return date.toLocaleDateString('pt-BR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
          };
          
          const lastRecord = filteredData[filteredData.length - 1];
          document.getElementById('subtitle').textContent = 
            `Intervalo: ${formatDateForDisplay(startDate)} até ${formatDateForDisplay(endDate)} - Ibovespa: ${lastRecord.formattedValue} pontos`;
        }
      });
    }
    
    // Carregar dados de exemplo (em caso de falha na requisição)
    function loadSampleData() {
      console.log('Carregando dados de exemplo...');
      
      // Gerar dados de exemplo para demonstração
      allIbovespaData = [];
      const startDate = new Date(2023, 0, 1);
      const baseValue = 100000;
      
      for (let i = 0; i < 365; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        // Valor com variação aleatória
        const randomChange = (Math.random() - 0.5) * 0.03;
        const value = i === 0 ? baseValue : allIbovespaData[i-1].value * (1 + randomChange);
        
        // Gerar dados de exemplo para as 30 empresas
        const empresas = [];
        for (let j = 0; j < 30; j++) {
          // Cada empresa tem um valor entre 1000 e 5000
          const empresaValue = 1000 + Math.random() * 4000;
          empresas.push(empresaValue);
        }
        
        allIbovespaData.push({
          date: currentDate,
          dateStr: formatDate(currentDate),
          value: value,
          formattedValue: value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
          empresas: empresas
        });
      }
      
      // Atualizar subtítulo
      const lastRecord = allIbovespaData[allIbovespaData.length - 1];
      document.getElementById('subtitle').textContent = `DADOS DE EXEMPLO - Última atualização: ${lastRecord.dateStr} - Ibovespa: ${lastRecord.formattedValue} pontos`;
      
      // Carregar pesos de exemplo
      loadSampleWeightsData();
      
      // Configurar as datas mínima e máxima para os campos de entrada
      setupDateInputs();
      
      // Mostrar controles de período e esconder indicador de carregamento
      document.getElementById('periodControls').style.display = 'flex';
      document.getElementById('loadingIndicator').style.display = 'none';
      
      // Criar gráfico principal
      createMainChart();
      
      // Inicializar com filtro de 1 mês
      filterDataByMonths(1);
      
      // Configurar eventos dos botões
      setupPeriodButtons();
      
      // Configurar evento para o botão de intervalo personalizado
      setupCustomRangeButton();
      
      // Configurar eventos de validação em tempo real para os campos de data
      setupDateValidation();
      
      // Mostrar aviso que são dados de exemplo
      document.getElementById('subtitle').textContent = 'DADOS DE EXEMPLO - ' + document.getElementById('subtitle').textContent;
    }
    
    // Função auxiliar para formatar data
    function formatDate(date) {
      return date.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }
    
    // Redimensionar gráfico quando a janela for redimensionada
    function handleResize() {
      if (ibovespaChart) {
        ibovespaChart.resize();
      }
    }
    
    // Inicializar aplicação
    function init() {
      console.log('Inicializando aplicação do Ibovespa...');
      
      // Configurar eventos de redimensionamento
      window.addEventListener('resize', handleResize);
      
      // Carregar dados do Ibovespa
      loadIbovespaData();
    }
    
    // Iniciar quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
