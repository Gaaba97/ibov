// Filtrar dados por intervalo de datas personalizado
function filterDataByCustomRange(startDate, endDate) {
  if (allIbovespaData.length === 0) return false;
  
  // CORREÇÃO: Adicionar 1 dia à data final para incluir o dia todo
  const endDateAdjusted = new Date(endDate);
  endDateAdjusted.setDate(endDateAdjusted.getDate() + 1);
  
  filteredData = allIbovespaData.filter(record => {
    return record.date >= startDate && record.date < endDateAdjusted;
  });
  
  // Se não houver dados no intervalo, mostrar mensagem
  if (filteredData.length === 0) {
    alert('Nenhum dado encontrado para o intervalo selecionado.');
    return false;
  }
  
  // Atualizar gráfico
  updateMainChartData();
  return true;
}

// Configurar evento para o botão de intervalo personalizado
function setupCustomRangeButton() {
  const applyBtn = document.getElementById('applyCustomRange');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const startDateError = document.getElementById('startDateError');
  const endDateError = document.getElementById('endDateError');
  const periodButtons = document.querySelectorAll('.period-btn');
  
  applyBtn.addEventListener('click', function() {
    // Validar datas
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    
    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      alert('Por favor, selecione datas válidas.');
      return;
    }
    
    // Verificar se a data é inferior a 30/12/2024
    const minAllowedDate = MIN_ALLOWED_DATE;
    let hasError = false;
    
    if (startDate < minAllowedDate) {
      startDateError.textContent = `Menor data disponível 30/12/2024`;
      startDateError.style.display = 'block';
      startDateInput.style.borderColor = '#ff0000';
      hasError = true;
    }
    
    if (endDate < minAllowedDate) {
      endDateError.textContent = `Menor data disponível 30/12/2024`;
      endDateError.style.display = 'block';
      endDateInput.style.borderColor = '#ff0000';
      hasError = true;
    }
    
    if (hasError) {
      return;
    }
    
    if (startDate > endDate) {
      alert('A data de início deve ser anterior à data de fim.');
      return;
    }
    
    // Remover classe 'active' de todos os botões de período
    periodButtons.forEach(btn => btn.classList.remove('active'));
    
    // Aplicar filtro personalizado - CORREÇÃO: Usar data final corrigida
    if (filterDataByCustomRange(startDate, endDate)) {
      // Atualizar subtítulo com o intervalo selecionado
      const formatDateForDisplay = (date) => {
        return date.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      };
      
      const lastRecord = filteredData[filteredData.length - 1];
      document.getElementById('subtitle').textContent = 
        `Intervalo: ${formatDateForDisplay(startDate)} até ${formatDateForDisplay(endDate)} - Ibovespa: ${lastRecord.formattedValue} pontos`;
    }
  });
}
